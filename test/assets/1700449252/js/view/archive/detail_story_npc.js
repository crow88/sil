define(["backbone","view/archive/abstract-detail","view/popup","model/sound","model/data-loader","view/archive/story/event-scene-app","event/treasureraid036/view/cjs/cjs-summon_get","constant/archive","util/navigate","util/language-message"],function(a,b,c,d,e,f,g,h,i,j){var k={DUNGEON:70270,REVIVAL:72520},l=b.extend({attr:null,event_popup_info:null,character_id:null,event_name:null,particularTitleId:"archive_page_title_npc",events:{"tap .btn-play-episode":"episodePlay","tap .btn-play-voice":"playVoice","tap .prt-episode-event .btn-episode-event:not(.sidestory)":"locationEvent","tap .prt-episode-event .btn-episode-event.sidestory":"locationSidestory","tap .pop-event-reward .btn-usual-close":"popEventRemove"},initialize:function(a){this.attr=a,a.type="story_npc",a.id_prefix="character",b.prototype.initialize.apply(this,[a]),_.extend(this.events,b.prototype.events)},render:function(){return this.character_id=this.detail_model.get("character_id"),d.loadArchiveVoiceData(this.character_id),this.event_popup_info&&this.pop_get_reward(),b.prototype.render.call(this)},content_close:function(){e.clear(),b.prototype.content_close.call(this)},data_extend:function(a){var b=this.detail_model.toJSON(),c={episode_list:b.episode,scenes:b.scenes,other_episode:b.other_episode,imageName:this.getImageName(a.param_id)};_.extend(a,c)},getImageName:function(a){return a+"_01"},episodePlay:function(a){var b=$(a.currentTarget),c=b.data("index"),d=!0,e=this.detail_model.get("episode")[c],g=e.comic_id||0;this.scene_list=e.scene_list,this.scene_list&&!_.isArray(this.scene_list)&&(this.scene_list=[this.scene_list]);var h=this.scene_list.shift();0!==+g?this.locationComic(g):b.hasClass("is-cjs")?this.playCjs(h.replace(".js","")):(this.loadStart(),this.bind("sceneAllEnd",this.sceneAllEnd),this.scene_view&&this.removeSubView(this.scene_view),this.scene_view=new f({scene_id:h,forwardFlg:5,scene_list:this.scene_list,play_view:this,archive_flg:d}),this.addSubView(this.scene_view))},playCjs:function(b){if("summon_get_idol_all"===b){var c={cjsName:b,width:640,height:960,canvasId:"cjs-summon_get",endEvent:"playEnd",playView:g,bgm:"bgm/77_never_ending_fantasy_inst_09.mp3"};window.scrollTo(0,0);var e=this.$el.find(".canv-detail-common"),f=this;e.attr({id:c.canvasId,width:c.width,height:c.height}).addClass("show"),this.$el.find(".cnt-detail").children(":not(canvas)").remove();var h=new c.playView;this.addSubView(h),_.isNull(c.bgm)||d.playBGM(c.bgm),e.one(c.endEvent,function(){h.cjsRemove(),f.content_close(),a.history.fragment="",a.history.navigate(location.hash,!0)})}},playVoice:function(){var a=this.detail_model.get("character_id");d.playSoundArrayInOrder(a,"archive_voice")},event_story_play:function(a){this.loadStart(),this.bind("sceneAllEnd",this.sceneAllEnd);var b=a.get("scene_id");this.event_popup_info=a.get("pop"),this.scene_list=[],this.scene_view&&this.removeSubView(this.scene_view),this.scene_view=new f({scene_id:b,forwardFlg:5,scene_list:this.scene_list,play_view:this}),this.addSubView(this.scene_view)},locationEvent:function(a){var b=this.attr,c=$(a.currentTarget).data("index"),d=this.detail_model.toJSON().entry_event_list[c],e=d.group_id||null,f=b.eventCategory||h.EVENT_TAB.ANOTHER,g=+d.location_id,j=+d.id||null,l=[j||g,b.back_flg,b.user_id,b.kind,b.attribute,b.page,b.param_id,b.active_tab],m="detail_story_npc";l.push(null,m);var n;j?n="archive/story/limited":_.isUndefined(b.prevHash)?null!==e?(n="archive/story/group",l=[e,b.back_flg,f]):n=_.contains(k,+this.location_id)?"archive/story/chapter_valentine":"archive/story/chapter":(n="archive/story/event/relatedstory",l=[g,b.prevHash]),_.each(l,function(a){n+="/"+a}),b.eventCategory&&(n+="/"+b.eventCategory),this.content_close(),i.hash(n)},locationSidestory:function(){this.content_close(),i.hash("sidestory",{refresh:!1,trriger:!0})},locationComic:function(a){this.content_close(),i.hash("comic/"+a,{refresh:!1})},sceneAllEnd:function(){this.content_close(),this.delegateEvents(this.events),this.scene_view&&this.removeSubView(this.scene_view),this.initialize(this.attr)},pop_get_reward:function(){this.popView=new c({className:"pop-event-reward "+this.event_name,title:j.getMessage("archive_9"),body:_.template($("#tpl-get-reward").html(),this.event_popup_info),flagBtnClose:1}),this.popView.render(),this.popView.popShow()},popRemove:function(){this.isSelectBranch=!1,this.popView.popRemove()},popEventRemove:function(){this.popView&&(this.popView.popRemove(),this.event_popup_info=null)},loadStart:function(){Game.loading.loadStart()}});return l});