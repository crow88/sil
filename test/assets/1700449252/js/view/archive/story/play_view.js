define(["backbone","model/content","view/content","model/data","view/archive/constant","view/archive/story/event-scene-app","util/navigate"],function(a,b,c,d,e,f,g){var h=10267,i=80010,j=1,k=2,l=3,m={COOP:1,DEFEND_ORDER:2},n=c.extend({content_model:null,episode_list:null,scene_view:null,event_flg:!1,isDefendOrderScene:!1,events:{"tap .location-href:not(.disable)":"location_href"},initialize:function(a){this.content_bind(),this.location_id=a.location_id,this.chapter_id=a.chapter_id,this.back_flg=a.back_flg,this.play_id=a.play_id,this.playIdSub=a.playIdSub||null,this.event_id=a.event_id,this.coop_flg=!1,this.branch_npcs=a.branch_npcs||null,this.answer_id=a.answer_id||null,this.comicId=a.comicId||null,this.userId=a.userId,this.kind=a.kind,this.attribute=a.attribute,this.page=a.page,this.paramId=a.paramId,this.activeTab=a.activeTab,this.eventIdNum=a.eventIdNum,this.archivePage=a.archivePage,this.eventName=a.eventName||null,this.eventController=a.eventController||null,this.freeQuestCategory=a.freeQuestCategory||null,this.eventCategory=a.eventCategory||0,this.groupId=a.groupId||0,this.sidestoryId=a.sidestoryId,this.eventHash=a.eventHash,this.isDigest=!1,this.isQuestBranch=!!a.isQuestBranch,this.questBranchList=a.questBranchList||null,this.prevHash=a.prevHash||null,$.isNumeric(this.chapter_id)===!1&&"extra"!==this.chapter_id?(this.event_flg=!0,this.eventCheckPlay(this.chapter_id)):"coopraid"==this.location_id?(this.coop_flg=!0,this.page=a.chapter_id,this.playCoopScene(this.play_id,this.playIdSub)):"defendorder"==this.location_id?(this.isDefendOrderScene=!0,this.page=a.chapter_id,this.playDefendOrderScene(this.play_id)):this.location_id===e.STORY_SUBSTITUTE_LOCATION_ID.DIGEST?(this.isDigest=!0,this.page=a.chapter_id,this.playScene(this.play_id)):0!=this.chapter_id?(this.episode_list=new(d.extend({urlRoot:Game.baseUri+"archive/story_episode_list/"+this.location_id+"/"+this.chapter_id})),this.listenToOnce(this.episode_list,"change",this.checkPlay),this.episode_list.fetch()):this.playOpening(this.play_id)},checkPlay:function(){var a=this.episode_list.get("list")[this.play_id];if(a.scene_file)return void this.playScene(a.scene_file);var b=Game.baseUri+"archive/scene_list/"+this.location_id+"/"+a.quest_id;(0==this.answer_id||1==this.answer_id)&&(b+="/"+this.answer_id),this.comicId&&(b+="/"+this.comicId);var c=new(d.extend({urlRoot:b}));this.listenToOnce(c,"change",this.locationPlay),c.fetch()},eventCheckPlay:function(a){var b=new Array(a);this.scene_list=b,this.scene_id=b.shift(),this.locationPlay("event")},locationPlay:function(a){this.event_flg||(this.scene_list=a.get("scene_list"),this.scene_id=a.get("scene_list").shift()),this.bind("sceneAllEnd",this.sceneAllEnd),this.scene_view&&this.removeSubView(this.scene_view),this.scene_view=new f({scene_id:this.scene_id,forwardFlg:5,scene_list:this.scene_list,play_view:this,coop_flg:0,branch_npcs:this.branch_npcs,isQuestBranch:this.isQuestBranch,questBranchList:this.questBranchList}),this.addSubView(this.scene_view)},playScene:function(a){this.event_flg||(this.scene_list=[],this.scene_id=a),this.bind("sceneAllEnd",this.sceneAllEnd),this.scene_view&&this.removeSubView(this.scene_view),this.scene_view=new f({scene_id:this.scene_id,forwardFlg:5,scene_list:this.scene_list,play_view:this,coop_flg:0,branch_npcs:this.branch_npcs,isQuestBranch:this.isQuestBranch,questBranchList:this.questBranchList}),this.addSubView(this.scene_view)},playOpening:function(a){var b=new Array("scene_tutorial00","scene_tutorial01","scene_tutorial02","scene_tutorial03");this.bind("sceneAllEnd",this.sceneAllEnd);var c=b[a-1];this.scene_view&&this.removeSubView(this.scene_view),this.scene_view=new f({scene_id:c,forwardFlg:5,scene_list:"",play_view:this,coop_flg:0}),this.addSubView(this.scene_view)},playCoopScene:function(a,b){this.scene_list=[],_.isNull(b)===!1&&this.scene_list.push(b),this.bind("sceneAllEnd",this.sceneAllEnd),this.scene_view&&this.removeSubView(this.scene_view),this.scene_view=new f({scene_id:a,forwardFlg:5,scene_list:this.scene_list,play_view:this,coop_flg:1}),this.addSubView(this.scene_view)},playDefendOrderScene:function(a){var b=this;this.on("sceneAllEnd",function(){$(this).off("sceneAllEnd"),b.sceneAllEnd()}),this.scene_view&&this.removeSubView(this.scene_view),this.scene_view=new f({scene_id:a,forwardFlg:5,scene_list:"",play_view:this,isDefendOrder:!0}),this.addSubView(this.scene_view)},sceneAllEnd:function(){var a,b;if(this.eventCategory){var c=[this.back_flg,this.eventCategory,this.page];this.event_flg?this.event_id?(a="archive/story/event/limited",b=[this.event_id].concat(c)):(a="archive/story/event",b=[this.location_id].concat(c),this.groupId&&b.push(this.groupId)):(a="archive/story/play_list_event",b=[this.location_id,this.chapter_id].concat(c),this.groupId&&b.push(this.groupId))}else if(this.event_flg)this.event_id?(a="archive/story/limited",b=[this.event_id,this.back_flg]):_.isNull(this.prevHash)?(a="archive/story/chapter",b=[this.location_id,this.back_flg]):(a="archive/story/event/relatedstory",b=[this.location_id,this.prevHash]);else if(this.coop_flg||this.isDefendOrderScene){var d=this.isDefendOrderScene?m.DEFEND_ORDER:m.COOP;a="archive/story/other/"+d,b=[this.back_flg||0,this.page||1]}else this.chapter_id==h||this.location_id==i?(a="archive/story/chapter",this.location_id!=i&&(this.location_id=i),b=[this.location_id,this.back_flg]):+this.freeQuestCategory===j||+this.freeQuestCategory===k||+this.freeQuestCategory===l?(this.archivePage=!1,a="archive/story/free_quest",b=[this.freeQuestCategory,this.back_flg,this.page]):this.eventHash?(a="archive/story/play_list_event",b=[this.location_id,this.chapter_id,this.back_flg,this.eventHash]):this.isDigest?(a="archive/story",b=[this.back_flg,this.page]):_.isNull(this.prevHash)?(a="archive/story/play_list",b=[this.location_id,this.chapter_id,this.back_flg],this.sidestoryId&&b.push(this.sidestoryId)):(a="archive/story/play_list_relatedstory",b=[this.location_id,this.chapter_id,this.prevHash]);var e=[];if(this.archivePage)switch(e=[this.userId,this.kind,this.attribute,this.page,this.paramId,this.activeTab],this.archivePage){case"detail_npc":case"detail_story_npc":e=e.concat([this.eventIdNum,this.archivePage]);break;case"detail_npc_solotreasure":case"detail_npc_sidestory":case"detail_npc_event":e=e.concat([this.eventName,this.eventIdNum,this.eventController,this.archivePage])}b=b.concat(e),_.each(b,function(b){a+="/"+b}),this.destroySubViews(),this.content_close(),g.hash(a,{refresh:!0})},loadStart:function(){Game.loading.loadStart()},location_href:function(b){if("true"==$(b.currentTarget).attr("disable"))return!1;var c=$(b.currentTarget).data("location-href");return null==c?!1:(this.content_close(),void a.history.navigate(c,!0))}});return n});