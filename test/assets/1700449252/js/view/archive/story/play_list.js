define(["backbone","model/content","view/content","model/data","view/popup","util/path","util/language-message"],function(a,b,c,d,e,f,g){var h={MAIN:0,EVENT:1,OTHER:2},i={EVENT:"archive/story/event",EVENT_LIMITED:"archive/story/event/limited"},j=c.extend({content_model:null,episode_list:null,hasBothBranch:!1,chapterUrlHead:"archive/story/chapter",events:{"tap .btn-play:not(.uncleared):not(.has-branch):not(.has-answer-branch):not(.has-comic-branch)":"checkPlay","tap .btn-play.has-branch:not(.uncleared)":"popSelectBranch","tap .btn-play.has-answer-branch:not(.uncleared):not(.has-branch)":"popSelectAnswerBranch","tap .btn-play.has-comic-branch:not(.uncleared):not(.has-branch)":"popSelectComicBranch","tap .pop-select-branch .btn-usual-cancel":"popRemove","tap .pop-select-branch .btn-usual-ok":"checkSelectedBranchChar","tap .pop-select-branch .btn-select-char:not(.disabled)":"toggleBranchChar","tap .pop-select-answer .btn-usual-text":"checkSelectAnswer","tap .pop-select-answer .btn-usual-cancel":"popRemove","tap .pop-select-comic .btn-select-comic":"checkSelectComic","tap .pop-select-comic .btn-usual-cancel":"popRemove","tap .locationChapter":"locationChapter","tap .locationSidestory":"locationSidestory","tap .locationScenario":"locationScenarioTop","tap .locationGroup":"locationGroup","tap .locationArchive":"locationArchiveTop","tap .locationEventTop":"locationEventTop","tap .location-href:not(.disable)":"location_href"},initialize:function(a){this.content_bind(),this.location_id=a.location_id,this.chapter_id=a.chapter_id,this.back_flg=a.back_flg,this.userId=a.userId,this.kind=a.kind,this.attribute=a.attribute,this.page=a.page,this.paramId=a.paramId,this.activeTab=a.activeTab,this.eventIdNum=a.eventIdNum,this.archivePage=a.archivePage,this.eventName=a.eventName||null,this.eventController=a.eventController||null,this.eventCategory=a.eventCategory||0,this.groupId=a.groupId||0,this.sidestoryId=a.sidestoryId,this.eventHash=a.eventHash,this.prevHash=a.prevHash||null,this.content_model=new b({controller:"archive",action:"play_list"}),this.listenToOnce(this.content_model,"change",this.render),0!=this.chapter_id&&(this.episode_list=new(d.extend({urlRoot:Game.baseUri+"archive/story_episode_list/"+this.location_id+"/"+this.chapter_id})),this.listenToOnce(this.episode_list,"change",_.bind(function(a){this.list_render(a),this.renderLeadLink()},this))),this.content_model.fetch()},render:function(){if(this.content_render(this.content_model),0==this.chapter_id){var a={title:g.getMessage("archive_38"),chapter_name:g.getMessage("archive_39"),id:0,list:{1:{episode_name:g.getMessage("archive_40"),is_cleared:!0,quest_id:"01"},2:{episode_name:g.getMessage("archive_41"),is_cleared:!0,quest_id:"02"},3:{episode_name:g.getMessage("archive_42"),is_cleared:!0,quest_id:"03"},4:{episode_name:g.getMessage("archive_43"),is_cleared:!0,quest_id:"04"}}};a.chapterTitleStyle=this._getChapterTitleStyle(this.getTextWidth(a.chapter_name));var b=$("#tpl-play-list").html();b&&(this.$el.find(".cnt-playlist-box").html(_.template(b,a)),$(".btn-prev-chapter").css("display","none"),$(".btn-next-chapter").css("display","none")),this.trigger("loadEnd")}else this.episode_list.fetch();$(".prt-head-current").html(g.getMessage("archive_37"))},getTextWidth:function(a){return this.$el.find(".text-width-check").text(a).width()},_getChapterTitleStyle:function(a){var b="";switch(!0){case 140>=a:b="title-orm-wide";break;case 204>=a:b="title-orm-narrow";break;default:b="title-orm-none"}return b},list_render:function(a){var b,c,d=a.toJSON(),e=this.getTextWidth(d.chapter_name);this.part=d.part,this.isMainScenario=!!d.is_main_scenario,""==d.prev_chapter?$(".btn-prev-chapter").css("display","none"):(c="archive/story/play_list/"+d.prev_location_id+"/"+d.prev_chapter+"/"+this.back_flg,this.eventCategory?(c="archive/story/play_list_event/"+d.prev_location_id+"/"+d.prev_chapter+"/"+this.back_flg+"/"+this.eventCategory+"/"+this.page,this.groupId&&(c+="/"+this.groupId)):this.archivePage?c+=this._getArchiveAddParamString():this.sidestoryId?c+="/"+this.sidestoryId:this.eventHash?c="archive/story/play_list_event/"+d.prev_location_id+"/"+d.prev_chapter+"/"+this.back_flg+"/"+this.eventHash:_.isNull(this.prevHash)||(c="archive/story/play_list_relatedstory/"+d.prev_location_id+"/"+d.prev_chapter+"/"+this.prevHash),$(".btn-prev-chapter").attr("data-location-href",c).addClass("location-href")),""==d.next_chapter?$(".btn-next-chapter").css("display","none"):(b="archive/story/play_list/"+d.next_location_id+"/"+d.next_chapter+"/"+this.back_flg,this.eventCategory?(b="archive/story/play_list_event/"+d.next_location_id+"/"+d.next_chapter+"/"+this.back_flg+"/"+this.eventCategory+"/"+this.page,this.groupId&&(b+="/"+this.groupId)):this.archivePage?b+=this._getArchiveAddParamString():this.sidestoryId?b+="/"+this.sidestoryId:this.eventHash?b="archive/story/play_list_event/"+d.next_location_id+"/"+d.next_chapter+"/"+this.back_flg+"/"+this.eventHash:_.isNull(this.prevHash)||(b="archive/story/play_list_relatedstory/"+d.next_location_id+"/"+d.next_chapter+"/"+this.prevHash),$(".btn-next-chapter").attr("data-location-href",b).addClass("location-href")),70001==this.location_id?d.title=g.getMessage("archive_44"):70010==this.location_id?d.title=g.getMessage("archive_45"):70020==this.location_id&&(d.title=g.getMessage("archive_46")),d.chapterTitleStyle=this._getChapterTitleStyle(e),this.$el.find(".cnt-playlist-box").html(_.template($("#tpl-play-list").html(),d)),this.trigger("loadEnd")},_getArchiveAddParamString:function(){var a="",b=[this.userId,this.kind,this.attribute,this.page,this.paramId,this.activeTab];switch(this.archivePage){case"detail_npc":case"detail_story_npc":b=b.concat([this.eventIdNum,this.archivePage]);break;case"detail_npc_solotreasure":case"detail_npc_sidestory":case"detail_npc_event":b=b.concat([this.eventName,this.eventIdNum,this.eventController,this.archivePage])}return _.each(b,function(b){a+="/"+b}),a},checkPlay:function(a){this.loadStart();var b=$(a.currentTarget),c=b.data("id");this.locationPlayView(c,0,null,null,null)},locationPlayView:function(b,c,d,e){var f="archive/story/play_view/"+this.location_id+"/"+this.chapter_id+"/"+this.back_flg+"/"+b;if(f+=this.hasBothBranch?"/"+e+"/"+d:1===c?"/null/"+d:0==e||1==e?"/"+e+"/null":"/null/null",this.eventCategory)0===c&&this.hasBothBranch===!1&&(d=null),0==e||1==e?f="archive/story/play_view_event_answer/"+this.location_id+"/"+this.chapter_id+"/"+this.back_flg+"/"+b+"/"+this.eventCategory+"/"+this.page+"/"+d+"/"+e:(f="archive/story/play_view_event/"+this.location_id+"/"+this.chapter_id+"/"+this.back_flg+"/"+b+"/"+this.eventCategory+"/"+this.page+"/"+d,this.groupId&&(f+="/"+this.groupId));else if(this.archivePage){var g=[this.userId,this.kind,this.attribute,this.page,this.paramId,this.activeTab];switch(this.archivePage){case"detail_npc":case"detail_story_npc":g=g.concat([this.eventIdNum,this.archivePage]);break;case"detail_npc_solotreasure":case"detail_npc_sidestory":case"detail_npc_event":g=g.concat([this.eventName,this.eventIdNum,this.eventController,this.archivePage])}_.each(g,function(a){f+="/"+a})}else this.sidestoryId?f="archive/story/play_view_sidestory/"+this.location_id+"/"+this.chapter_id+"/"+this.back_flg+"/"+b+"/"+e+"/"+d+"/"+this.sidestoryId:this.eventHash?f+="/"+this.eventHash:_.isNull(this.prevHash)||(f="archive/story/play_view_relatedstory/"+this.location_id+"/"+this.chapter_id+"/"+b+"/"+this.prevHash+"/"+d);this.content_close(),a.history.navigate(f,!0)},locationChapter:function(b){this.content_close();var c,d=this.chapterUrlHead;if(this.eventCategory)d=i.EVENT,c=[this.location_id,this.back_flg,this.eventCategory,this.page],this.groupId&&c.push(this.groupId);else if(this.archivePage)switch(c=[this.location_id,this.back_flg,this.userId,this.kind,this.attribute,this.page,this.paramId,this.activeTab],this.archivePage){case"detail_npc":case"detail_story_npc":c=c.concat([this.eventIdNum,this.archivePage]);break;case"detail_npc_solotreasure":case"detail_npc_sidestory":case"detail_npc_event":c=c.concat([this.eventName,this.eventIdNum,this.eventController,this.archivePage])}else c=[this.location_id,this.back_flg];_.each(c,function(a){d+="/"+a}),a.history.navigate(d,!0)},locationSidestory:function(){var b="sidestory/story/"+this.sidestoryId;this.content_close(),a.history.navigate(b,!0)},locationEventTop:function(){var b=this.eventHash.replace(/!/g,"/");this.content_close(),a.history.navigate(b,!0)},locationScenarioTop:function(){var b="";this.isMainScenario||(this.part=null),b=this.eventCategory?"archive/story_tab/"+h.EVENT+"/"+this.page+"/"+this.back_flg+"/"+this.eventCategory:"archive/story/"+this.back_flg+(this.part?"/"+this.part:""),this.content_close(),a.history.navigate(b,!0)},locationGroup:function(){this.content_close(),a.history.navigate("archive/story/group/"+this.groupId+"/"+this.back_flg+"/"+this.eventCategory+"/"+this.page,!0)},locationArchiveTop:function(){this.content_close(),a.history.navigate(this.back_url,!0)},loadStart:function(){Game.loading.loadStart()},popSelectBranch:function(a){var b=$(a.currentTarget);this.hasBothBranch=b.hasClass("has-answer-branch"),this.episodeIndex=b.data("id");var c=this.episode_list.toJSON();this.selectedEpisodeData=c.list[this.episodeIndex],this.selectedEpisodeData.isCharacterId=_.some(this.selectedEpisodeData.npc_list,function(a){return a.is_character_id}),this.hasEpisodeNpc=_.some(this.selectedEpisodeData.npc_list,function(a){return a.has_npc}),this.popView=new e({className:"pop-select-branch",title:g.getMessage("archive_10"),body:_.template($("#tpl-pop-select-branch").html(),this.selectedEpisodeData),flagBtnCancel:1,flagBtnClose:0,flagBtnOk:1}),this.popView.render().popShow()},checkSelectedBranchChar:function(){this.trigger("xhrStart");var a=[],b=this,c=this.$el.find(".pop-select-branch .btn-select-char");c.each(function(c){if($(this).hasClass("selected")){var d=$(this).data("index"),e=b.selectedEpisodeData.npc_list[d].npc_id;a.push(e)}});var d="0";0<a.length&&(d=a.join(",")),this.hasBothBranch?(this.branchNpcs=d,this.popView&&this.popView.popRemove(),this.popSelectAnswerBranch()):this.locationPlayView(this.episodeIndex,1,d,null,null)},toggleBranchChar:function(a){var b=$(a.currentTarget);b.hasClass("selected")?b.removeClass("selected"):b.addClass("selected")},popSelectAnswerBranch:function(a){this.trigger("xhrStart"),this.hasBothBranch||(this.episodeIndex=$(a.currentTarget).data("id")),this.popView=new e({className:"pop-select-answer",title:g.getMessage("archive_10"),body:g.getMessage("archive_52")+'<div class="prt-answer-branch"><div class="btn-usual-text" data-answer="0">'+g.getMessage("archive_53")+'</div><div class="btn-usual-text" data-answer="1">'+g.getMessage("archive_54")+"</div></div>",flagBtnCancel:1,flagBtnClose:0,flagBtnOk:0}),this.popView.render().popShow(),this.trigger("xhrEnd")},checkSelectAnswer:function(a){var b=$(a.currentTarget).data("answer"),c=0,d=null;this.hasBothBranch&&(c=1,d=_.clone(this.branchNpcs),this.branchNpcs=""),this.locationPlayView(this.episodeIndex,c,d,b,null)},popSelectComicBranch:function(a){this.episodeIndex=$(a.currentTarget).data("id"),this.popView=new e({className:"pop-select-comic",title:g.getMessage("comic_1"),body:$("#tpl-pop-select-comic").html(),flagBtnCancel:1,flagBtnOk:0}),this.popView.render().popShow()},checkSelectComic:function(b){var c=$(b.currentTarget).data("comic"),d="archive/story/play_view_comic/"+this.location_id+"/"+this.chapter_id+"/"+this.back_flg+"/"+this.episodeIndex+"/"+c;this.eventCategory&&(d+="/"+this.eventCategory+"/"+this.page),this.content_close(),a.history.navigate(d,!0)},popRemove:function(){this.episodeIndex=null,this.popView.popRemove()},renderLeadLink:function(){if(!_.isNull(this.prevHash)){var a=f.replaceHashSeparator(this.prevHash);return void $("#prt-lead-link").html(_.template($("#tpl-prt-lead-link").html(),{locationId:this.location_id,prevHash:this.prevHash,replacePrevHash:a}))}1===+this.back_flg?(this.back_url="profile",$(".locationArchive .atx-lead-link").html(g.getMessage("archive_36"))):this.back_url="archive/top",this.eventCategory&&!_.isNull(this.episode_list.get("group_name"))&&this.$el.find(".locationGroup").css("display","block").find(".atx-lead-link").text(g.replaceMessage("archive_61",[this.episode_list.get("group_name")])),this.sidestoryId?this.$el.find(".locationChapter").removeClass("locationChapter").addClass("locationSidestory").find(".atx-lead-link").text(g.getMessage("locationSidestory")):this.eventHash&&this.$el.find(".locationChapter").removeClass("locationChapter").addClass("locationEventTop").find(".atx-lead-link").text(g.getMessage("locationEventTop"))},location_href:function(b){if("true"==$(b.currentTarget).attr("disable"))return!1;var c=$(b.currentTarget).data("location-href");return null==c?!1:(this.content_close(),void a.history.navigate(c,!0))}});return j});