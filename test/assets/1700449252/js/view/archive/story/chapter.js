define(["backbone","model/content","view/content","view/popup","model/data","view/archive/story/event-scene-app","view/archive/story/pop-select-quest-branch","view/archive/story/pop-pose-unlocked","util/path","util/navigate","util/page-slider","util/string","util/language-message","constant/archive"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){var o={MAIN:0,EVENT:1,OTHER:2},p={COOP:1,DEFEND_ORDER:2},q={1:{dataHref:"arcarum2/index_force",getMessageText:"arcarum_1"},2:{dataHref:"replicard",getMessageText:"archive_replicard_1"},3:{dataHref:"event/interlude",getMessageText:"interlude_title"}},r={PLAY_LIST_EVENT:"archive/story/play_list_event",PLAY_LIST_EVENT_LIMITED:"archive/story/play_list_event_limited",PLAY_LIST_EVENT_VALENTINE:"archive/story/play_list_event_valentine",PLAY_LIST_EVENT_RELATEDSTORY:"archive/story/play_list_relatedstory"},s={DUNGEON:70270,REVIVAL:72520},t=78820,u=c.extend({content_model:null,chapterList:null,movie:null,page:1,otherCategory:0,playListUrlHead:"archive/story/play_list",events:{"tap .btn-chapter:not(.uncleared):not(.has-branch):not(.has-additional):not(.arcarum):not(.coop):not(.defendorder):not(.has-quest-branch)":"locationPlayList","tap .btn-chapter.has-branch:not(.uncleared)":"popSelectBranch","tap .prt-chapter-list .btn-chapter.has-quest-branch":"popSelectQuestBranch","tap .btn-chapter.arcarum:not(.has-branch)":"locationArcarumPlay","tap .pop-select-branch .btn-usual-cancel":"popRemove","tap .pop-unopened-detail .btn-usual-close":"popRemove","tap .pop-select-branch .btn-usual-ok":"checkSelectedBranchChar","tap .pop-select-branch .btn-select-char:not(.disabled)":"toggleBranchChar","tap .btn-chapter.has-additional":"locationAdditional","tap .prt-chapter-list .btn-chapter.coop":"locationCoopScene","tap .prt-chapter-list .btn-chapter.defendorder":"locationDefendOrderScene","tap .locationScenario":"locationScenarioTop","tap .locationArchive":"locationArchive","tap .locationGroup":"locationGroup","tap .locationLibrary":"locationLibrary","tap .location-href:not(.disable)":"location_href","tap .cnt-chapter-box .btn-scenario-link":"switchScenario","tap .cnt-chapter-box .btn-special-setting":"onTapSpecialSetting","tap .prt-pager .btn-page-number":"pagination","tap .prt-chapter-btns .btn-chapter-tab":"switchContent","tap .btn-chapter-character.unopened":"popUnopenedItemDetail","tap .pop-select-quest-branch .btn-usual-cancel":"popRemove"},initialize:function(a){this.content_bind(),this.location_id=a.location_id,this.back_flg=a.back_flg,this.event_id=a.event_id,this.userId=Game.userId,this.kind=a.kind,this.attribute=a.attribute,this.page=a.page,this.paramId=a.paramId,this.activeTab=a.activeTab,this.eventIdNum=a.eventIdNum,this.archivePage=a.archivePage,this.eventName=a.eventName||null,this.eventController=a.eventController||null,this.otherCategory=a.otherCategory||0,this.eventCategory=a.eventCategory||0,this.groupId=a.groupId||0,this.listCategory=a.listCategory||1,this.fromLibrary=a.fromLibrary||!1,this.categoryId=a.categoryId||0,this.topicId=a.topicId||0,this.prevHash=a.prevHash||null,this.chapterListProps={},this.characterListProps={},this.content_model=new b({controller:"archive",action:"chapter"}),this.listenToOnce(this.content_model,"change",this.render),+this.otherCategory===p.COOP?this.chapterList=new(e.extend({urlRoot:Game.baseUri+"archive/coop_list/"+this.page})):+this.otherCategory===p.DEFEND_ORDER?this.chapterList=new(e.extend({urlRoot:Game.baseUri+"archive/defendorder_list/"+this.page})):this.event_id?this.chapterList=new(e.extend({urlRoot:Game.baseUri+"archive/story_limited_list/"+this.event_id})):this.chapterList=new(e.extend({urlRoot:Game.baseUri+"archive/story_chapter_list/"+this.location_id})),this.listenToOnce(this.chapterList,"change",_.bind(function(a){var b=a.toJSON();this.list_render(a),this.renderLeadLink(b),this.popPoseUnlocked(b.popup_data)},this)),this.content_model.fetch()},render:function(){+this.location_id===t&&this.loadAdditionalCss("/archive/story_button_special_setting.css","page-story-button-special-setting"),this.content_render(this.content_model),this.chapterList.fetch(),$(".prt-head-current").html(m.getMessage("archive_37")),this.movie=document.getElementById("video"),this.trigger("loadEnd")},list_render:function(a){var b=a.toJSON(),c=0;if(+this.otherCategory===p.COOP||+this.otherCategory===p.DEFEND_ORDER){var d,e="",f="";switch(+this.otherCategory){case p.COOP:d=$("#tpl-coop-list"),e="coop-quest",f="stage_name";break;case p.DEFEND_ORDER:d=$("#tpl-defendorder-list"),e="defendorder-quest",f="chapter_name"}c=l.getMaxLengthInCollection(b.list,f),this.$el.find(".cnt-chapter-box").addClass(e).html(_.template(d.html(),{data:b,maxTitleLength:c}));var g={first:b.first,prev:b.prev,next:b.next,last:b.last,page:this.page},h={paging:this.$el.find(".prt-pager"),text:this.$el.find(".prt-pager-text")};return void k.render(g,!0,h)}var i={};if(this.part=b.part,this.isMainScenario=!!b.is_main_scenario,_.each(b.chapter_list,function(a,b){i[b]=_.extend(a,{id:a.chapter_id,hash:a.chapter_id})}),c=l.getMaxLengthInCollection(b.chapter_list,"chapter_name"),b.chapter_list=i,10001==this.location_id)b.scenario_title=m.getMessage("archive_38"),b.chapter_list={0:{id:"prologue",chapter_name:m.getMessage("archive_47")},1:{id:0,chapter_name:m.getMessage("archive_39")}};else if(70670==this.location_id){if(_.has(b.chapter_list,1)&&_.has(b.chapter_list,2)){var j={1:_.clone(b.chapter_list[2]),2:_.clone(b.chapter_list[1])};70672==j[1].chapter_id&&70671==j[2].chapter_id&&(b.chapter_list[1]=j[1],b.chapter_list[2]=j[2])}}else if(70950==this.location_id&&_.has(b.chapter_list,1)&&_.has(b.chapter_list,2)){var j={1:_.clone(b.chapter_list[2]),2:_.clone(b.chapter_list[1])};70952==j[1].chapter_id&&70951==j[2].chapter_id&&(b.chapter_list[1]=j[1],b.chapter_list[2]=j[2])}_.isUndefined(b.has_additional)===!0&&(b.has_additional=[]),b.listCategory=this.listCategory;var o="other";this.location_id?_.contains(s,+this.location_id)&&(o="valentine"):o="limited";var q=b.npc_list.map(function(a){var b,c=1===+a.npc_type,d=c?a.data_story_npc:a.data_npc,e=c?a.data_story_npc.id_of_npc_story_master:a.data_npc.id_of_npc_master,f=c?!!a.data_story_npc.message:!a.data_npc.is_joined,g=c?a.data_story_npc.name:a.data_npc.name,h=d.is_cleared?c?a.data_story_npc.message:"":m.getMessage("archive_59"),i=!e,j="";f||(b=0===+this.eventCategory&&+this.groupId!==n.GROUP_ID.INTERLUDE?["archive",c?"detail_story_npc":"detail_npc",this.userId,this.kind+"",this.attribute+"",this.page+"",e,this.activeTab+"",this.back_flg,this.eventCategory]:["archive",c?"detail_story_npc":"detail_npc",this.userId,c?"1":"0","0",1,e,3,this.back_flg,this.location_id||this.event_id,this.eventCategory,o,this.groupId||""],_.isNull(this.prevHash)===!1&&(b=["archive","detail_npc_relatedstory",this.userId,c?"1":"0",e,this.location_id,this.prevHash]),j=_.compact(b).join("/"));var k=c?a.data_story_npc.awakening_level:a.data_npc.awakening_level;0===k.length?k="01":1===k.length&&(k="0"+k);var l=i?"1999999999":e+"_"+k,p=f?" unopened":"";return{id:e,href:j,name:g,imageId:l,optionalClasses:p,message:h}}.bind(this));this.characterListProps={characters:q},this.$el.find(".cnt-chapter-box").html(_.template($("#tpl-chapter-list").html(),{data:b,maxTitleLength:c})),this.chapterListProps=_.clone(b),this.chapterListProps.maxTitleLength=c,2===+this.listCategory?this.renderCharacterList():this.renderChapterList()},popPoseUnlocked:function(a){if(0!==_.size(a)){var b=a.open_additional_pose.length>0?a.open_additional_pose:a.open_additional_pose_not_join_npc;if(0!==b.length){var c=new h({data:b[0]});c.render().popShow()}}},renderChapterList:function(){this.$el.find(".prt-chapter-content").html(_.template($("#tpl-prt-chapter-list").html(),this.chapterListProps))},renderCharacterList:function(){this.$el.find(".prt-chapter-content").html(_.template($("#tpl-prt-character-list").html(),this.characterListProps))},locationArcarumPlay:function(a){var b=$(a.currentTarget),c=this.chapterList.toJSON();this.selectChapterId=b.data("id"),this.location_id=b.data("location-id")||c.scenario_id,20008==this.selectChapterId?this.locationPlayList(a):this.locationEventPlay(this.selectChapterId,0,0)},locationPlayList:function(b){var c=$(b.currentTarget);if(this.selectChapterId=c.data("id"),"prologue"==this.selectChapterId)return this.play_prologue();if($.isNumeric(this.selectChapterId)===!1&&"extra"!==this.selectChapterId)return this.locationEventPlay(this.selectChapterId,0,null);var d=this.getEpisodeUrlParameter(this.playListUrlHead);this.content_close(),a.history.navigate(d,!0)},locationEventPlay:function(b,c,d,e,f){this.loadStart();var g="";if(e){g="archive/story/play_view_branch/";var h={chapterId:b,backFlg:this.back_flg,playId:1,page:this.page,isQuestBranch:1,groupId:this.groupId};if(c&&(h.branchNpcs=d),_.isEmpty(f)||(h.questBranchList=f),this.event_id?h.eventId=this.event_id:h.locationId=this.location_id,this.eventCategory&&(h.eventCategory=this.eventCategory),this.archivePage){h=_.extend(h,{userId:this.userId,kind:this.kind,attribute:this.attribute,page:this.page,paramId:this.paramId,activeTab:this.activeTab,eventIdNum:this.eventIdNum,archivePage:this.archivePage});var i=["detail_npc_solotreasure","detail_npc_sidestory","detail_npc_event"];_.contains(i,this.archivePage)&&(h=_.extend(h,{eventName:this.eventName,eventController:this.eventController}))}g+=j.serializeHashParam(h)}else if(this.eventCategory)0===c&&(d=null),g=this.event_id?"archive/story/play_view_event_limited/"+this.event_id+"/"+b+"/"+this.back_flg+"/1/"+this.eventCategory+"/"+this.page+"/"+d:"archive/story/play_view_event/"+this.location_id+"/"+b+"/"+this.back_flg+"/1/"+this.eventCategory+"/"+this.page+"/"+d,this.groupId&&(g+="/"+this.groupId);else if(g=this.event_id?"archive/story/play_view_limited/"+this.event_id+"/"+b+"/"+this.back_flg+"/1":_.isNull(this.prevHash)?"archive/story/play_view/"+this.location_id+"/"+b+"/"+this.back_flg+"/1/null":"archive/story/play_view_relatedstory/"+this.location_id+"/"+b+"/1/"+this.prevHash,g+=1===c?"/"+d:"/null",this.archivePage){var k=[this.userId,this.kind,this.attribute,this.page,this.paramId,this.activeTab];switch(this.archivePage){case"detail_npc":case"detail_story_npc":k=k.concat([this.eventIdNum,this.archivePage]);break;case"detail_npc_solotreasure":case"detail_npc_sidestory":case"detail_npc_event":k=k.concat([this.eventName,this.eventIdNum,this.eventController,this.archivePage])}_.each(k,function(a){g+="/"+a})}this.content_close(),a.history.navigate(g,!0)},getEpisodeUrlParameter:function(a){var b;if(_.isNull(this.prevHash))if(this.eventCategory){var c=_.contains(s,+this.location_id);a=c===!0?r.PLAY_LIST_EVENT_VALENTINE:r.PLAY_LIST_EVENT,b=[this.location_id,this.selectChapterId,this.back_flg,this.eventCategory,this.page],this.groupId&&b.push(this.groupId)}else if(this.archivePage)switch(b=[this.location_id,this.selectChapterId,this.back_flg,this.userId,this.kind,this.attribute,this.page,this.paramId,this.activeTab],this.archivePage){case"detail_npc":case"detail_story_npc":b=b.concat([this.eventIdNum,this.archivePage]);break;case"detail_npc_solotreasure":case"detail_npc_sidestory":case"detail_npc_event":b=b.concat([this.eventName,this.eventIdNum,this.eventController,this.archivePage])}else b=[this.location_id,this.selectChapterId,this.back_flg];else a=r.PLAY_LIST_EVENT_RELATEDSTORY,b=[this.location_id,this.selectChapterId,this.prevHash];var d=a;return _.each(b,function(a){d+="/"+a}),d},locationScenarioTop:function(){var b;if(this.isMainScenario||(this.part=null),this.archivePage){var c=[this.archivePage,this.userId,this.kind,this.attribute,this.page,this.paramId,this.activeTab];switch(this.archivePage){case"detail_npc":case"detail_story_npc":c.push(this.back_flg);break;case"detail_npc_solotreasure":case"detail_npc_sidestory":c.push(this.eventIdNum);break;case"detail_npc_event":c=c.concat([this.eventName,this.eventIdNum,this.eventController])}b="archive",_.each(c,function(a){b+="/"+a}),this.eventCategory&&(b+="/"+this.eventCategory),this.back_url=b}else b=_.contains(n.EVENT_TAB,+this.eventCategory)?"archive/story_tab/"+o.EVENT+"/"+this.page+"/"+this.back_flg+"/"+this.eventCategory:this.event_id&&!this.eventCategory?"archive/story_tab/"+o.EVENT+"/1/"+this.back_flg:_.contains(p,+this.otherCategory)||q[+this.chapterListProps.arcarum_link_type]?"archive/story_tab/"+o.OTHER+"/1/"+this.back_flg:"archive/story/"+this.back_flg+(this.part?"/"+this.part:"");this.content_close(),a.history.navigate(b,!0)},locationArchive:function(){this.content_close(),a.history.navigate(this.back_url,!0)},locationGroup:function(){this.content_close(),a.history.navigate("archive/story/group/"+this.groupId+"/"+this.back_flg+"/"+this.eventCategory+"/"+this.page,!0)},locationLibrary:function(){this.content_close(),a.history.navigate("archive/library/"+this.categoryId+"/"+this.topicId+"/1",!0)},play_prologue:function(){this.content_close(),a.history.navigate("archive/story/play_prologue/"+this.back_flg,!0)},popSelectBranch:function(a){var b=$(a.currentTarget);this.chapterIndex=b.data("index"),this.chapterId=b.data("id");var c=this.chapterList.toJSON();this.selectedChapterData=c.chapter_list[this.chapterIndex],this.selectedChapterData.isCharacterId=_.some(this.selectedChapterData.npc_list,function(a){return a.is_character_id}),this.hasEpisodeNpc=_.some(this.selectedChapterData.npc_list,function(a){return a.has_npc}),this.popView=new d({className:"pop-select-branch",title:m.getMessage("archive_10"),body:_.template($("#tpl-pop-select-branch").html(),this.selectedChapterData),flagBtnCancel:1,flagBtnClose:0,flagBtnOk:1}),this.popView.render().popShow()},checkSelectedBranchChar:function(){this.trigger("xhrStart");var a=[],b=this,c=this.$el.find(".pop-select-branch .prt-select-one-char"),d=this.$el.find(".pop-select-branch .btn-select-char");if(c.length&&a.push(c.val()),d.each(function(c){if($(this).hasClass("selected")){var d=$(this).data("index"),e=b.selectedChapterData.npc_list[d].npc_id;a.push(e)}}),0<a.length){var e=a.join(",");this.locationEventPlay(this.chapterId,1,e)}else this.locationEventPlay(this.chapterId,1,"0")},toggleBranchChar:function(a){var b=$(a.currentTarget);b.hasClass("selected")?b.removeClass("selected"):b.addClass("selected")},popSelectQuestBranch:function(a){var b=$(a.currentTarget),c=b.data();this.chapterId=c.id;var d=c.index,e=this.chapterList.toJSON().chapter_list[d];this.popView=new g(e.quest_list,function(a){this.popView.popRemove(),this.locationEventPlay(this.chapterId,0,null,!0,a)}.bind(this)),this.popView.render().popShow()},popRemove:function(){this.popView.popRemove()},loadStart:function(){Game.loading.loadStart()},location_href:function(b){if("true"==$(b.currentTarget).attr("disable"))return!1;var c=$(b.currentTarget).data("location-href");return null==c?!1:(this.content_close(),void a.history.navigate(c,!0))},locationAdditional:function(b){var c=$(b.currentTarget).data("id"),d=this.chapterList.toJSON().scenario_id;this.content_close(),a.history.navigate("archive/story/additional/"+this.back_flg+"/"+c+"/"+d+"/"+this.eventCategory+"/"+this.page,!0)},locationCoopScene:function(b){var c=$(b.currentTarget),d=c.data("opening-scene"),e=c.data("ending-scene"),f=this.page+"/"+this.back_flg+"/"+d,g="play_view";""!==e&&(f+="/"+e,g="play_view_coop"),this.content_close(),a.history.navigate("archive/story/"+g+"/coopraid/"+f,!0)},locationDefendOrderScene:function(b){var c=$(b.currentTarget).data("scene");this.content_close(),a.history.navigate("archive/story/play_view/defendorder/"+this.page+"/"+this.back_flg+"/"+c,!0)},switchScenario:function(){var b=this.$el.find(".btn-scenario-link"),c=b.data("scenario-id");2===+b.data("select-kind")&&(c+="_1"),this.content_close(),a.history.navigate("archive/story/event/"+c+"/"+this.back_flg+"/"+this.eventCategory+"/"+this.page,!0)},onTapSpecialSetting:function(){this.popSpecialSetting()},popSpecialSetting:function(){function a(a){d.listenToOnce(a,"closeSpecialSetting",function(a){d.chapterListProps.event_ffxi_config=a}),a.render(d.chapterListProps.event_ffxi_config).popShow()}var b,c,d=this;Game.loading.xhrStart(),new Promise(function(a){d.loadAdditionalCss("/archive/story_pop_special_setting.css","page-story-pop-special-setting",{isAddAfterInitialize:!0,loadCompleteCallback:a})}).then(function(){return new Promise(function(a){require(["view/archive/story/pop_special_setting"],function(c){b=c,a(b)})})}).then(function(b){Game.loading.xhrEnd(),c=new b,a(c)}),this.popSpecialSetting=function(){c=new b,a(c)}},pagination:function(a){var b=$(a.currentTarget);return"true"==b.attr("disable")?!1:(this.page=b.attr("page"),+this.otherCategory===p.COOP?this.chapterList.url=Game.baseUri+"archive/coop_list/"+this.page:+this.otherCategory===p.DEFEND_ORDER&&(this.chapterList.url=Game.baseUri+"archive/defendorder_list/"+this.page),this.stopListening(this.chapterList),this.listenToOnce(this.chapterList,"sync",this.list_render),void this.chapterList.fetch())},switchContent:function(a){var b="btn-story"===$(a.currentTarget).attr("id");$(a.currentTarget).addClass("active").siblings().removeClass("active"),this.listCategory=b?1:2,b?this.renderChapterList():this.renderCharacterList()},popUnopenedItemDetail:function(a){var b=$(a.currentTarget);this.popView=new d({className:"pop-unopened-detail",title:m.getMessage("archive_58"),body:_.template($("#tpl-pop-unopened-detail").html(),b.data()),flagBtnClose:1}),this.popView.render().popShow()},renderLeadLink:function(a){var b=a.group_name||null;if(1===+this.back_flg?(this.back_url="profile",this.$el.find(".locationArchive .atx-lead-link").html(m.getMessage("archive_36"))):this.back_url="archive/top",!_.isNull(this.prevHash)){var c=i.replaceHashSeparator(this.prevHash);return void $("#prt-lead-link").html(_.template($("#tpl-prt-lead-link").html(),{prevHash:c}))}this.archivePage?this.$el.find(".locationScenario .atx-lead-link").html(m.getMessage("archive_back_btn_1")):this.eventCategory&&!_.isNull(b)?this.$el.find(".locationGroup").css("display","block").find(".atx-lead-link").text(m.replaceMessage("archive_61",[b])):this.eventCategory&&this.$el.find(".locationScenario .atx-lead-link").html(m.getMessage("archive_60")),this.fromLibrary&&this.$el.find(".locationLibrary").css("display","block");var d=$("#js-lead-next");switch(!0){case!!q[+a.arcarum_link_type]:var e=q[+a.arcarum_link_type].dataHref,f=m.getMessage(q[+a.arcarum_link_type].getMessageText);d.attr({"data-href":e}).find(".atx-lead-link").text(f);break;case+this.otherCategory===p.COOP:d.attr({"data-href":"coopraid"}).find(".atx-lead-link").text(m.getMessage("coopraid_1"));break;case+this.otherCategory===p.DEFEND_ORDER:d.remove()}}});return u});