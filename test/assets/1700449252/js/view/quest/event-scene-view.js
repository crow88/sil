define(["underscore","backbone","collection/quest/scenario-collection","collection/quest/coop-scenario-collection","collection/quest/archaic-scenario-collection","collection/quest/archaic-job-scenario-collection","collection/quest/archaic-bahamut-scenario-collection","collection/quest/casino-scenario-collection","collection/quest/archive-scenario-collection","loadmanager","general","view/quest/abstract-view","view/quest/event-scene-talk-view","view/quest/event-scene/event-scene-log-view","view/quest/sub/_sub_vw_receive_item","view/cjs/cjs-phit_sw_0002","view/cjs/cjs-ehit_0001","view/cjs/cjs-ab_3000","view/cjs/cjs-scene-effect","view/cjs/cjs-scene-effect-load","view/cjs/cjs-scene-private","view/cjs/cjs-quest_encount","view/popup","lib/quest/extension","lib/sound","model/sound","lib/shellapp","model/token-data","util/path","util/string","util/scroll","util/language","util/language-message","util/navigate"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H){var I={LOG_CLOSE:"logClose"},J=null,K=null,L=[1,2,3],M="/sp/spacer.png",N=[0,1,2],O={CAT:"3020072000"},P={COMIC:"782432"},Q="se/serif_se_ffxi_1.mp3",R=function(){z.playSE("se/btn_se_ffxi_01.mp3")},S=["#cjs-scene-effect-container",".prt-character-display","#cjs-bg-effect-container",".prt-scene-bg"],T=".prt-character-display",U="chara_command",V="@@",W="autoSceneSelectTimeout",X=3e3,Y={_SHOW:"_show",_HIDE:"_hide",L_SLIDE_IN:"L-slidein",R_SLIDE_IN:"R-slidein",T_SLIDE_IN:"T-slidein",B_SLIDE_IN:"B-slidein",L_SLIDE_OUT:"L-slideout",R_SLIDE_OUT:"R-slideout",T_SLIDE_OUT:"T-slideout",B_SLIDE_OUT:"B-slideout",FADE_IN:"fadein",FADE_OUT:"fadeout",SCENE_CJS:"sceneCjs",CJS_DELETE:"cjsDelete",CJS_FADE:"cjsFade",COLOR_START:"color_start",COLOR_END:"color_end",COLOR_FADE_IN:"color_fadein",COLOR_FADE_OUT:"color_fadeout",SET_COLOR_SCREEN_TARGET:"setColorScreenTarget",INIT_COLOR_SCREEN_TARGET:"initColorScreenTarget",VIBRATE_LOOP_START:"vibrate_loop_start",VIBRATE_LOOP_END:"vibrate_loop_end",BLACK_IN:"blackin",BLACK_OUT:"blackout",NEXT_FORCEFUL:"next_forceful",TIME_FADE_IN:"time_fadein",TIME_FADE_OUT:"time_fadeout"},Z=l.extend({effectCjs:null,isForcefulNext:!1,el:".cnt-quest-scene",charaList:[],tutorialInputtedName:"",tutorialTempNameStatus:N[0],shouldReplaceTempName:!1,latestVoice:"",questId:0,DURATION_WAITING_MS:800,isArcarumScene:!1,redirectUrl:"",callbackSetRedirectUrl:null,events:{"tap .prt-next-btn-area, .prt-scene-comment":"next","tap .img-skip":"end","tap .prt-sel-inner .btn-select-balloon":"onTapSelectBalloon",'tap .prt-sel-area [class*="img-choice"]':"selImgNext","tap .prt-scene-comment .btn-play-voice":"playButtonVoice","tap .prt-sel-area .btn-sel-taparea":"dummyButtonVoice","tap .prt-comic-display":"next"},initialize:function(b){this.stopStageEvent(),this.content_bind(),this.init(),this.coop_flg=0,this.archaic_flg=0,this.casino_flg=0,this.archive_flg=0,this.isSelectedSelImg=!1;var j=b.seasonEventId||0,k=b.sex||!1,l=b.uniqueId||0,m=b.event_id||0,n=b.isBirthdayScenario||!1,o=b.isStoryNpc||0;b.coop_flg&&(this.coop_flg=b.coop_flg),b.archaic_flg&&(this.archaic_flg=b.archaic_flg),b.casino_flg&&(this.casino_flg=b.casino_flg),b.archive_flg&&(this.archive_flg=b.archive_flg);var p=b.skyScenarioController||!1,q=b.isDefendOrder||!1,r=b.isSolotreasure||!1,s=b.isEventScene||!1,t="",u="",v=b.isArchiveNpc||!1,w=b.questId||0,x=b.currentLocationId||null,y=b.questType||null,z=b.isSideStory||!1,A=b.transcendenceKind||"",B=null,D=b.isRelatedstory||!1,E=(b.isInterlude||!1,b.isReplicard);this.clearedSceneOnly=!!b.clearedSceneOnly,this.callbackSetRedirectUrl=b.callbackSetRedirectUrl,this.forcefulOpt=!1,this.isQuestBranch=!!b.isQuestBranch,this.questBranchList=b.questBranchList||null,this.isForceRedirect=b.isForceRedirect||!1,this.lastQuizAnswer={},this.isForceStopScenario=!1,null!==K&&this._clearSceneTimeoutID(),1==this.coop_flg?this.scenarioCollection=new d:1==this.archaic_flg?this.scenarioCollection=new e:2==this.archaic_flg?this.scenarioCollection=new f:3==this.archaic_flg?this.scenarioCollection=new g:this.casino_flg?this.scenarioCollection=new h:this.archive_flg?this.scenarioCollection=new i:(this.scenarioCollection=new c,b.scenarioCollectionUrl?this.scenarioCollection.url=Game.baseUri+b.scenarioCollectionUrl:A?this.scenarioCollection.url=C.join([Game.baseUri+"rest",A,"evolution/scenario_by_transcendence/"]):(j&&(this.scenarioCollection.url=Game.baseUri+"npc/season_event_scenario/"),r&&(u=b.eventModuleName,this.scenarioCollection.url=Game.baseUri+u+"/quest/scenario/"),s&&(u=b.eventModuleName,t=b.eventController,this.scenarioCollection.url=Game.baseUri+u+"/"+t+"/scenario/"),4===this.archaic_flg&&(this.scenarioCollection.url=Game.baseUri+"archaic/seraphic/scenario/"),z===!0&&(this.scenarioCollection.url=Game.baseUri+"rest/sidestory/scenario/"),m&&(this.scenarioCollection.url=D?Game.baseUri+"quest/scenario_for_related_story/"+w+"/":Game.baseUri+"quest/scenario_campaign/"),n&&(this.scenarioCollection.url=Game.baseUri+"archive/scenario_birthday/"),p&&(this.scenarioCollection.url=Game.baseUri+"sky/"+p+"/scenario/"),q&&(this.scenarioCollection.url=Game.baseUri+"defendorder/island/scenario/"),null!==x&&null!==y&&(this.scenarioCollection.url=Game.baseUri+"quest/scenario_epilogue/"+w+"/"+x+"/"+y+"/",B=b.firstClear||"0"),v?this.scenarioCollection.url=Game.baseUri+"quest/scenario_archive/"+w+"/":b.isArcarumScene&&(this.isArcarumScene=!0,this.scenarioCollection.url=Game.baseUri+"rest/arcarum/summon_scenario/"),this.clearedSceneOnly&&(this.scenarioCollection.url=Game.baseUri+"rest/quest/cleared_quest_scenario/"+w+"/"),this.isQuestBranch&&(this.scenarioCollection.url=Game.baseUri+"rest/quest/branch_quest_scenario/"),E&&(this.scenarioCollection.url=Game.baseUri+"rest/replicard/scenario/"))),this.questId=w,this.imageDownloadCompleted=!1,this.listenTo(this.scenarioCollection,"reset",this.checkScenarioData),this.scene_id=b.scene_id,this.forwardFlg=b.forwardFlg,this.nextUrl=b.nextUrl,this.areaId=b.areaId;var F=!!+b.isAgreedToSpoiler;this.completedQuestId=b.completed_quest_id,this.locationId=b.location_id,this.forceFirststoryPlay=b.forceFirststoryPlay,this.nextFateQuestId=b.nextFateQuestId,this.bookmarkPage=b.bookmarkPage,b.redirectUrl&&(this.redirectUrl=b.redirectUrl),this.sex=$(this.el).data("sex"),this.branch_npcs=b.branch_npcs||null,this.open_scene_hash=null,this.isTutorialScene=b.isTutorialScene||!1,this.isComicSelectScene="scene_evt180531_cp3_q2_s10_b"===this.scene_id&&a.isUndefined(this.archiveStoryFlag)===!0,this.popupStyleType=b.popupStyleType||"",this.isComicSelectScene===!0&&this.$el.find(".btn-skip").addClass("disable"),this.baseUrl=this.scenarioCollection.url;var G=this.scenarioCollection.url+this.scene_id;D&&(G+="/"+m),this.cjsMessage=null,a.isNull(B)||(G+="/"+B),this.seasonEventParam="",j&&(this.seasonEventParam="/"+b.isStoryNpc+"/"+j+"/"+b.viewCount+"/"+l,k!==!1&&(this.seasonEventParam+="/"+k),G+=this.seasonEventParam),m&&D===!1&&(G=G+"/"+o+"/"+m),n&&(G=G+"/"+o),null!=this.branch_npcs&&(G=G+"/"+this.branch_npcs),this.isQuestBranch&&this.questBranchList&&(G=G+"/"+this.questBranchList),this.forceFirststoryPlay&&(G=null!=this.branch_npcs?G+"/"+this.forceFirststoryPlay:G+"/0/"+this.forceFirststoryPlay),b.npcIds&&(G+="/"+b.npcIds),F&&(G=this.forceFirststoryPlay?C.join([G,1]):this.branch_npcs?C.join([G,0,1]):C.join([G,0,0,1])),this.scenarioCollection.url=G,this.scenarioCollection.fetch({reset:!0}),this.$char1=$("#char1"),this.$char2=$("#char2"),this.$char3=$("#char3"),this.$char1.hide(),this.$char2.hide(),this.$char3.hide(),this.$bg1=$("#bg1"),this.$bg2=$("#bg2"),this.$bg1.hide(),this.$bg2.hide(),this.scenario_index=0,this.next_scenario_index=0,this.sel_next1="",this.sel_next2="",this.sel_next3="",this.sel_next4="",this.sel_next5="",this.sel_next6="",this.postflag=0,this.hasResponseChoices=!1,this.scenes=[],this.playedScenarioIndexList=[],this.autoSelectedIndex={}},setEventSceneSkipView:function(a){this.eventSceneSkipView=a},start:function(){this.delegateEvents(this.events),this.trigger("loadEnd"),this.scenario_execute(this.scenario_index,!0),y.once("complete",function(){});var b=a.filter(a.uniq(a.map(this.scenarioCollection.models,function(a){return a.get("bgm")})),a.identity),c=a.filter(a.uniq(a.map(this.scenarioCollection.models,function(a){return a.get("se")})),a.identity);a.filter(a.uniq(a.map(this.scenarioCollection.models,function(a){return a.get("voice")})),a.identity);y.loadFiles(a.union(b,c)),this.isIOS15OrLater()&&(this.extendContentHeight(),this.onResizeFunc=this.extendContentHeight.bind(this),window.addEventListener("resize",this.onResizeFunc))},changeScene:function(a){var b=this;this._clearSceneTimeoutID(),this._clearNextSetTimeout(),this.hasResponseChoices=!1,this.initializeEffect(),this.command(null,{command:Y.COLOR_END},null),this.command(null,{command:Y.INIT_COLOR_SCREEN_TARGET},null),this.command(null,{command:Y.VIBRATE_LOOP_END},null),this.effectCjs&&"fadeCjs"===this.effectCjs.identifier&&this.command(null,{command:Y.BLACK_OUT+"(hide)"},null),cjs&&cjs.stage&&cjs.stage.scenePrivate&&this.command(null,{command:Y.CJS_DELETE},null),this.restoreScene(+a),this.setNamedTimeout("silentSeTimeout",function(){b.autoSelectedIndex={},b.next_scenario_index=0,b.scenario_index=+a,b.scenario_execute(b.scenario_index,!0)},10)},getFormattedCommandList:function(b){var c=this,d=[],e=b.command_list?b.command_list.split(V):[];return a.each(L,function(a){b["command"+a]&&d.push({command:b["command"+a],position:a})}),a.each(e,function(a){if(-1!==a.indexOf(U)){var b=c.getParam(a);d.push({command:b[0],position:+b[1]})}else d.push({command:a,position:null})}),d},restoreScene:function(b){var c=this,d=this.scenarioCollection.toJSON(),e=this.playedScenarioIndexList.lastIndexOf(+b);this.playedScenarioIndexList.splice(e);var f={bgm:"silent",bg1:M,charcter1_big_image:M,charcter2_big_image:M,charcter3_big_image:M,charcter1_position:"",charcter2_position:"",charcter3_position:""},g=a.map(L,function(){return{isShow:!1}}),h={color:null,colorScreenTarget:null,isVibrate:!1,isBlack:!1,sceneCjs:null,cjsFade:null};a.each(this.playedScenarioIndexList,function(b){var e=d[b];e.bgm&&(f.bgm=e.bgm),e.bg1&&(f.bg1=e.bg1),a.each(L,function(a){e["charcter"+a+"_big_image"]&&(f["charcter"+a+"_big_image"]=e["charcter"+a+"_big_image"]),e["charcter"+a+"_position"]&&(f["charcter"+a+"_position"]=e["charcter"+a+"_position"])});var i=c.getFormattedCommandList(e);a.each(i,function(a){if(a.command){var b=c.getCommand(a.command);switch(b){case Y.L_SLIDE_IN:case Y.R_SLIDE_IN:case Y.T_SLIDE_IN:case Y.B_SLIDE_IN:case Y.FADE_IN:case Y.TIME_FADE_IN:g[a.position-1].isShow=!0;break;case Y.L_SLIDE_OUT:case Y.R_SLIDE_OUT:case Y.T_SLIDE_OUT:case Y.B_SLIDE_OUT:case Y.FADE_OUT:case Y.TIME_FADE_OUT:g[a.position-1].isShow=!1;break;case Y.COLOR_START:case Y.COLOR_FADE_IN:h.color=a.command;break;case Y.COLOR_END:case Y.COLOR_FADE_OUT:h.color=null;break;case Y.SET_COLOR_SCREEN_TARGET:h.colorScreenTarget=a.command;break;case Y.INIT_COLOR_SCREEN_TARGET:h.colorScreenTarget=null;break;case Y.VIBRATE_LOOP_START:h.isVibrate=!0;break;case Y.VIBRATE_LOOP_END:h.isVibrate=!1;break;case Y.BLACK_IN:h.isBlack=!0;break;case Y.BLACK_OUT:h.isBlack=!1;break;case Y.SCENE_CJS:h.sceneCjs=a.command,h.cjsFade=null;break;case Y.CJS_DELETE:h.sceneCjs=null,h.cjsFade=null;break;case Y.CJS_FADE:h.cjsFade=a.command}}})});var i=d[+b];i.bgm||z.playBGM(f.bgm),i.bg1||this.bg_setting(this.$bg1,{image:f.bg1});var j=c.getFormattedCommandList(i),k=a.map(j,function(a){return c.getCommand(a.command)});if(a.each(L,function(b){var d=c["$char"+b],e=f["charcter"+b+"_big_image"],h=f["charcter"+b+"_position"];c.char_setting(d,{big_image:e,position:h,command:""});var i=a.chain(j).filter(function(a){return+a.position===b}).map(function(a){return a.command}).value();0===a.intersection([Y.L_SLIDE_IN,Y.R_SLIDE_IN,Y.T_SLIDE_IN,Y.B_SLIDE_IN,Y.FADE_IN,Y.L_SLIDE_OUT,Y.R_SLIDE_OUT,Y.T_SLIDE_OUT,Y.B_SLIDE_OUT,Y.FADE_OUT,Y.TIME_FADE_IN,Y.TIME_FADE_OUT],i).length&&(g[b-1].isShow?c.command(c["$char"+b],{command:Y._SHOW},h):c.command(c["$char"+b],{command:Y._HIDE},h))}),h.color&&0===a.intersection([Y.COLOR_START,Y.COLOR_FADE_IN,Y.COLOR_END,Y.COLOR_FADE_OUT],k).length){var l=c.getParam(h.color),m=l.slice(0,4).join(",");c.command(null,{command:Y.COLOR_START+"("+m+")"},null)}if(h.colorScreenTarget&&0===a.intersection([Y.SET_COLOR_SCREEN_TARGET,Y.INIT_COLOR_SCREEN_TARGET],k).length&&c.command(null,{command:h.colorScreenTarget},null),h.isVibrate&&0===a.intersection([Y.VIBRATE_LOOP_START,Y.VIBRATE_LOOP_END],k).length&&c.command(null,{command:Y.VIBRATE_LOOP_START},null),h.isBlack&&0===a.intersection([Y.BLACK_IN,Y.BLACK_OUT],k).length&&c.command(null,{command:Y.BLACK_IN+"(show)"},null),h.sceneCjs&&0===a.intersection([Y.SCENE_CJS,Y.CJS_DELETE],k).length&&c.command(null,{command:h.sceneCjs},null),h.cjsFade&&0===a.intersection([Y.SCENE_CJS,Y.CJS_DELETE,Y.CJS_FADE],k).length){var n=c.getParam(h.cjsFade)[0];c.command(null,{command:Y.CJS_FADE+"("+n+", 1)"},null)}},reduceLog:function(a){var b=this.scenarioCollection.at(+a).toJSON(),c=this.scenes.indexOf(+b.id);this.scenes.splice(c);for(var d=this.scenarioCollection.length-1,e=a;d>=e;e++)this.eventSceneLogView.remove(e)},isIOS15OrLater:a.memoize(function(){return Game.ua.isIOS()&&Game.ua.versionCompare(Game.ua.getOSVersion(),"15")>=0}),extendContentHeight:function(){var a=this.$el;this.extendContentHeight=function(){var b=$(window).height();a.css({minHeight:""}),a.height()<b&&a.css({minHeight:b})},this.extendContentHeight()},next:function(a,b){var c,d=this,e=function(){};if(b=b===!0,c=b&&this.forcefulOpt,!this.isForcefulNext||!this.forcefulOpt||b){this.isForcefulNext||d._clearSceneTimeoutID(),d._clearNextSetTimeout();var f=this.scenarioCollection.at(this.scenario_index);if(f&&""==f.get("sel1_txt")&&""==f.get("sel2_txt")&&""==f.get("sel3_txt")&&""==f.get("sel4_txt")&&f.get("sel_next1")&&f.get("sel_next2")&&f.get("sel_next3")&&f.get("sel_next4")&&f.get("sel_next5")&&f.get("sel_next6")&&(0==this.sex?this.scenario_index=f.get("sel_next1")-1:this.scenario_index=f.get("sel_next2")-1),this.imageDownloadCompleted&&"none"==$(".ico-cursor-talk").css("display")&&!c)this.scenario_execute(this.scenario_index,!1,null,!0);else if(this.imageDownloadCompleted&&"block"==$(".ico-cursor-talk").css("display")&&this.hasResponseChoices)this.scenario_execute(this.scenario_index,!1,!0,!0);else if(this.imageDownloadCompleted&&("block"==$(".ico-cursor-talk").css("display")||c))if(this.isVibrateCharStopNext&&(this.isVibrateCharStopSoon=!0,this.isVibrateCharStopNext=!1),this.isVibrateBgStopNext&&(this.isVibrateBgStopSoon=!0,this.isVibrateBgStopNext=!1),e=function(){"mute"!==a&&z.playNextSceneSE(d.ffxiMode?Q:""),d.isForcefulNext&&(d.isForcefulNext=!1,d._clearSceneTimeoutID()),d.scenario_index++,d.scenario_execute(d.scenario_index,!0,null,!0),null!=document.getElementById("bt-storyencoder")&&document.getElementById("bt-storyencoder").setAttribute("data-scnene-id",d.scenario_index)},this.isTutorialScene===!0&&this.tutorialTempNameStatus===N[1]){var g=function(a){d.tutorialTempNameStatus=N[2],d.setNicknameFont(),d.tutorialInputtedName=a,e()};this.trigger("shouldPopInputName",g)}else e()}},_clearSceneTimeoutID:function(){K&&window.clearTimeout(K),this.forcefulOpt&&(this.forcefulOpt=!1,this.$el.find(".btn-header.logView, .btn-header.btn-scene-skip").removeClass("disable btn-silent-se"),this.$el.find(".btn-bgm-change").off("tap.forcefulOpt"))},isSceneAuto:function(){return!$("#btn-auto").hasClass("off")},getCanProceedSelectIndexByScene:function(a,b){for(var c=[],d=1;a["sel_next"+d];d++)""!==a["sel_next"+d]&&c.push(+a["sel_next"+d]);if(c.every(function(a){return+b>a}))return"undefined"==typeof this.autoSelectedIndex[b]||this.autoSelectedIndex[b]===c.length?this.autoSelectedIndex[b]=1:++this.autoSelectedIndex[b];for(var e=0;c[e];e++){if("undefined"!=typeof this.autoSelectedIndex[b])return++this.autoSelectedIndex[b];var f=e+1;if(+c[e]>+b)return this.autoSelectedIndex[b]=f,f}},autoSceneSelect:function(){var a=this.scenarioCollection.at(+this.scenario_index).toJSON(),b=+this.getCanProceedSelectIndexByScene(a,+this.scenario_index);this.selectScene(b),this.ffxiMode?R():z.playSE("se/btn_se/btn_se_01.mp3")},tryAutoSceneSelect:function(){var a=this,b=0===this.$el.find(".btn-skip").length||this.hasQuiz()||this.isComicSelectScene;b||this.setNamedTimeout(W,function(){a.autoSceneSelect()},X)},onTapSelectBalloon:function(a){this.ffxiMode&&(a.stopPropagation(),R());var b=+$(a.currentTarget).data("select-index");this.selectScene(b)},selectScene:function(b){var c=this;this.getQuizIndex()?(this.quizSelNext(b),this.selectSceneAfter(b)):this.isComicSelectScene===!0?this.postScenarioSeltext(b,function(){c.$el.find(".btn-skip").removeClass("disable"),c.selectSceneAfter(b)}):a.isUndefined(this.isTreasureraid056)||this.isTreasureraid056!==!0?(this.$el.find(".btn-skip").show(),this.selectSceneAfter(b)):this.postScenarioSeltext(b,function(){c.selectSceneAfter(b)})},selectSceneAfter:function(a){var b=this.getSelectSceneLogObject(+this.scenario_index,a);this.eventSceneLogView.append(b),this.scenario_index=this["sel_next"+a]-1,this.next("mute")},getSelectSceneLogObject:function(a,b){var c,d=this.scenarioCollection.at(a).toJSON();return c=+d.quiz_id?this.quizData[d.quiz_id-1].choicelist[b-1].text:d["sel"+b+"_txt"],{scenarioIndex:a,characterName:G.getMessage("scene_select_character_name"),detail:D.stripTag(c),voice:n.VOICE_SILENT,isSelect:!0,canChangeScene:this.canChangeScene(d)}},scenarioAllShow:function(b){for(var c=this,d=this.scenarioCollection.toJSON(),e=this.scenarioCollection.length-1,f=[],g=d[b],h="undefined"!=typeof g.sel_next1&&""!==g.sel_next1,i="undefined"!=typeof g.next&&""!==g.next,j=b+!(h||i),k=j;e>=k;){var l=d[k];if((!h&&!i||k>j)&&(this.playedScenarioIndexList.push(+k),this.scenes.push(+l.id),f.push({scenarioIndex:k,characterName:l.charcter1_name,detail:l.detail,voice:l.voice,canChangeScene:this.canChangeScene(l)})),"undefined"!=typeof l.sel_next1&&""!==l.sel_next1){var m=+this.getCanProceedSelectIndexByScene(l,k),n=this.getSelectSceneLogObject(k,m);f.push(n),k=+l["sel_next"+m]}else"undefined"!=typeof l.next&&""!==l.next?k=+l.next:k++}a.each(f,function(a){c.eventSceneLogView.append(a)});var o=this.$el.find(".prt-log-display .prt-log-each"),p=o.eq(o.length-1).data("scenario-index"),q=b>=p?o.filter(function(){return $(this).data("scenario-index")<=b}).eq(0):o.filter('[data-scenario-index="'+p+'"]').eq(0);E.scrollToElement(q,{offset:-60*Game.getZoom(),duration:0})},getQuizIndex:function(){return this.$el.find(".prt-sel-inner").attr("data-quiz-index")},quizSelNext:function(a){this.lastQuizAnswer={index:this.getQuizIndex(),selectNo:a}},selImgNext:function(a){var b=this;this.isSelectedSelImg!==!0&&(this.isSelectedSelImg=!0,this.setNamedTimeout("imgNextTimeout",function(){var c=$(a.currentTarget);b.selimgNo=c.index()+1,b.scenario_index=+b["sel_next"+b.selimgNo]-1,b.next("mute")},500))},postScenarioSeltext:function(b,c){var d,e;this.isComicSelectScene===!0?(d="rest/sidestory/select_branch",e={seltext_no:b,quest_id:P.COMIC}):a.isUndefined(this.isTreasureraid056)===!1&&this.isTreasureraid056===!0&&(d="treasureraid056/quest/scenario_seltext",e={scene_id:this.scene_id,selimage_no:this.selimgNo,seltext_no:b});var f=new(B.extend({urlRoot:Game.baseUri+d}));this.listenToOnce(f,"sync",c),f.save(e)},setVwReceiveItemView:function(a){this.vwReceiveItemView=new o({seasonEventItemData:a}),this.addSubView(this.vwReceiveItemView);var b=this;this.listenToOnce(this.vwReceiveItemView,"popRemoveVwReceiveItem",function(){b.removeSubView(b.vwReceiveItemView),b.vwReceiveItemView.content_close(),b.end()})},end:function(){var a=this,c=this.vwReceiveItemView&&this.vwReceiveItemView.seasonEventItemData;return c?void this.vwReceiveItemView.readyPopReceiveItem():(cjs.stage.sceneEffect&&cjs.stage.sceneEffect.removeAllEventListeners("tick"),cjs.stage.scenePrivate&&cjs.stage.scenePrivate.removeAllEventListeners("tick"),void(this.open_scene_hash?(this.content_close(),b.history.navigate(this.open_scene_hash.join("/"),!0)):this.isForceRedirect?H.hash(this.redirectUrl):this.hasQuiz()?this.postQuizAnswer().done(function(){a.fowardTo(a.forwardFlg,a.areaId,a.completedQuestId,a.locationId,null,a.nextFateQuestId,a.bookmarkPage,a.redirectUrl,a.scene_id)}):this.fowardTo(this.forwardFlg,this.areaId,this.completedQuestId,this.locationId,null,this.nextFateQuestId,this.bookmarkPage,this.redirectUrl,this.scene_id)))},hasQuiz:function(){return!a.isEmpty(this.quizData)},postQuizAnswer:function(){var a=this;this.trigger("xhrStart");var b=new(B.extend({urlRoot:Game.baseUri+"rest/quest/scenequiz/answer_quiz"}));this.listenToOnce(b,"sync",function(){a.trigger("xhrEnd")});var c=this.quizData[this.lastQuizAnswer.index-1],d=c.choicelist[this.lastQuizAnswer.selectNo-1];return b.save({scene_id:this.scene_id,quiz_id:c.quiz_id,text:d.id})},click_on:function(){this.delegateEvents()},click_off:function(){this.$el.off("tap")},checkScenarioData:function(){var b=this.scenarioCollection.at(0).toJSON();this.quizData=b.quiz_data,this.hasQuiz()&&this.disableSkipBtn(),this.ffxiMode=b.ffxi_mode||0,this.clearedSceneOnly&&(this.redirectUrl=this.scenarioCollection.at(0).get("redirect_url"),this.callbackSetRedirectUrl(this.redirectUrl)),this.cjsMessage=a.clone(this.scenarioCollection.at(0).get("cjs_message")),this.eventSceneSkipView.cjsMessage=this.cjsMessage;var c=a.clone(this.scenarioCollection.at(0).get("scenario"));c&&(this.trigger("seasonMessageItem",{popup:b.popup,itemInfo:b.item_info}),this.scenarioCollection.set(c));var d=a.clone(this.scenarioCollection.at(0).get("scene_list")),e=this.scenarioCollection.at(0).get("move_scrapbook_detail");this.popupStyleType||(this.popupStyleType=this.scenarioCollection.at(0).get("popup_style_type"));var f=this.scenarioCollection.at(0).get("choice_image");$("#img-preload").empty(),f&&(this.$el.find(".prt-sel-area").addClass("sel"+f),$("#img-preload").append($('<div class="sel'+f+'">'))),d&&(0==a.isUndefined(e)&&e===!0&&(this.eventSceneSkipView.forwardFlg=this.forwardFlg=26,this.eventSceneSkipView.completedQuestId=this.completedQuestId=this.questId),this.scenarioCollection.set(d)),this.image_download()},image_download:function(){var b=this,c=[];this.scenarioCollection.each(function(d,e){d.get("synopsis")&&b.eventSceneSkipView.setSynopsis(d.get("chapter_name"),d.get("synopsis"),{popupStyleType:b.popupStyleType}),a(["charcter1_big_image","charcter1_small_image","charcter2_big_image","charcter2_small_image","charcter3_big_image","charcter3_small_image","bg1","bg2"]).each(function(a){var e=d.get(a);b.isNotEmpty(e)&&c.push(e)})});var d=new j;d._queueArr=[],d._registerArr=[],d._successArr=[],d._errorArr=[],d._isStarted=!1,d._isRunning=!1,d._isFinished=!1,d._currentQueues=[],d._queueCount=0;for(var e=0;e<c.length;e++)c[e]&&d.add(Game.imgUri+c[e]);d.onComplete=function(a){b.imageDownloadCompleted=!0,F.isJapanese()&&b.webfontSet(b.scene_id),b.start()},a.isEmpty(d._registerArr)?d.onComplete():d.start()},scenario_execute:function(b,c,d,e){var f=this;c&&0!==this.next_scenario_index&&(b=this.scenario_index=this.next_scenario_index,this.next_scenario_index=0),c&&this.playedScenarioIndexList.push(+b);var g=this.scenarioCollection.at(b);if(b==this.scenarioCollection.length)return void this.end();if(g){if("undefined"!=typeof g.get("force_stop_scenario")&&g.get("force_stop_scenario")&&(this.isForceStopScenario=!0),"undefined"!=typeof g.get("open_scene_file")&&g.get("open_scene_file")&&this.open_scene(g),"undefined"!=typeof g.get("next_scene_file")&&""!=g.get("next_scene_file"))return this.next_scene(g),void this._clearNextSetTimeout();""!=g.get("next")&&(this.next_scenario_index=g.get("next")),this.sel_next1=g.get("sel_next1"),this.sel_next2=g.get("sel_next2"),this.sel_next3=g.get("sel_next3"),this.sel_next4=g.get("sel_next4"),this.sel_next5=g.get("sel_next5"),this.sel_next6=g.get("sel_next6"),this.postflag=g.get("postflag"),"undefined"!=typeof this.sel_next1&&""!==this.sel_next1&&(this.hasResponseChoices=!0);var h;if(1===+g.get("text_send")?h=!1:(h=$("#scene_fast_text_mode").data("scene-fast-text-mode"),h="off"===h?!0:!1),this.forcefulOpt=1===+g.get("forceful_opt"),this._initAutoNext(),d===!0){var i=g.get("se");return i&&this.se_delay&&z.playSE(i),void this._playEventSceneTalk(g,h?c:!1,!0)}if(this._playEventSceneTalk(g,h?c:!1),(e||c===!1)&&this.charaList.forEach(function(b){a.contains([Y.L_SLIDE_IN,Y.L_SLIDE_OUT,Y.R_SLIDE_IN,Y.R_SLIDE_OUT,Y.T_SLIDE_IN,Y.T_SLIDE_OUT,Y.B_SLIDE_IN,Y.B_SLIDE_OUT,Y.TIME_FADE_IN,Y.TIME_FADE_OUT],f.getCommand(b.command))&&b.chara_obj.stop(!0,!0)}),0==c)return void(this.charaList=[]);if(-1===$.inArray(+g.id,this.scenes)){this.scenes.push(+g.id),a.isUndefined(this.eventSceneLogView)===!0&&(this.eventSceneLogView=new n,this.addSubView(this.eventSceneLogView),this.listenTo(this.eventSceneLogView,n.TRIGGER.ON_TAP_LOG,function(a){f.reduceLog(+a),f.changeScene(+a),f.trigger(I.LOG_CLOSE),f.triggerClearNextSetTimeout()}));var j=g.toJSON();this.eventSceneLogView.append({scenarioIndex:b,characterName:j.charcter1_name,detail:j.detail,voice:j.voice,canChangeScene:this.canChangeScene(j)})}var k=[];a(3).times(function(a){var b=a+1,c=f.getCharaCommandConfig(g,null,b);f.char_setting(f["$char"+b],c),k.push(c),f.charaList.push(c)});var l=g.get("command_list")||null,m=l?l.split(V):null;a.each(m,function(a){if(-1!==a.indexOf(U)){var b=f.getParam(a),c=b[0],d=+b[1],e=f.getCharaCommandConfig(g,c,d);f.char_setting(f["$char"+d],e),k[d-1]=e,f.charaList[d-1]=e}else+f._getNextParameter([{command:a}])&&f._clearNextDeferred(),f.command(null,{command:a},null)});var o=+this._getNextParameter(k);o&&this._clearNextDeferred();var p={name:"&nbsp;"};if(this.isNotEmpty(k[0].name)&&(p=k[0]),f.bg_setting(f.$bg1,{image:g.get("bg1")}),f.$bg1.show(),f.bg_setting(f.$bg2,{image:g.get("bg2")}),-1!==this.scene_id.indexOf("scene_evt180531_cp0_q2_s10_com")&&f.bg_setting($("#comic"),{image:"/sp/quest/scene/comic/"+this.scene_id+".jpg"}),this.isTutorialScene===!0&&!a.isEmpty(this.tutorialInputtedName)&&this.tutorialTempNameStatus===N[2]||this.shouldReplaceTempName===!0){var q=this.shouldReplaceTempName===!0?this.$el.data("nick-name"):this.tutorialInputtedName;p.name=p.name.replace("<span class='nickname'></span>",q)}this.$(".txt-character-name").html("<span>"+p.name+"</span>"),f.se_delay=!1,a.each(k,function(a,b){"play_se_choices"==a.command&&(f.se_delay=!0)});var r,i;r=g.get("bgm"),r&&z.playBGM(r),i=g.get("se"),i&&!f.se_delay&&z.playSE(i),z.stopVoice(),this.latestVoice&&"silent"!==this.latestVoice&&y.destroy(this.latestVoice);var s=g.get("voice")||"";if(this._playVoice(s),this.latestVoice=s,!Game.setting.effect_mode||y.isSupportedHTMLAudio()&&!y.isSupportedWebAudio()&&!y.isSupportedNativeAudio()){var t=this.$el.find(".btn-play-voice");"silent"==s&&(s=""),t.attr("data-voice",s);var u=s&&p.name&&!p.name.match(/^[\s　]$/)?"block":"none";t.css("display",u)}var v=this.scenarioCollection.at(b+1);v&&(r=v.get("bgm"),r&&z.loadBGM(r),i=v.get("se"),i&&z.loadSE(i),s=v.get("voice"),s&&!this.isDisabledVoice()&&z.loadVoice(s))}},canChangeScene:function(b){var c=this;if(this.isTutorialScene&&"scene_tutorial01"===this.scene_id)return!1;var d=1===+b.forceful_opt,e=a.map(L,function(a){return b["command"+a]}).concat(b.command_list?b.command_list.split(V):[]),f=a.some(e,function(a){var b=c.getCommand(a);return b===Y.NEXT_FORCEFUL});return!(d&&f)},getCharaCommandConfig:function(a,b,c){var d=a.toJSON();return{name:d["charcter"+c+"_name"],big_image:d["charcter"+c+"_big_image"],small_image:d["charcter"+c+"_small_image"],position:d["charcter"+c+"_position"],command:b||d["command"+c],effect:d["effect"+c],chara_obj:this["$char"+c]}},open_scene:function(b){var c=this,d=b.get("open_scene_file"),e=location.hash.split("/");this.open_scene_hash=e,a.each(e,function(a,b){"scene_"===a.substr(0,6)&&"scene_intro"!==a.substr(0,11)&&(c.open_scene_hash[b]=d)}),this.eventSceneSkipView.setOpenScene(this.open_scene_hash.join("/"))},next_scene:function(b){var c=b.get("next_scene_file");this.scene_id=c,this.scenarioCollection.url=this.baseUrl+this.scene_id,a.isEmpty(this.seasonEventParam)||(this.scenarioCollection.url=this.scenarioCollection.url+this.seasonEventParam),null!=this.branch_npcs&&(this.scenarioCollection.url=this.scenarioCollection.url+"/"+this.branch_npcs),this.isQuestBranch&&this.questBranchList&&(this.scenarioCollection.url=this.scenarioCollection.url+"/"+this.questBranchList),this.isRelatedstory&&(this.scenarioCollection.url=this.scenarioCollection.url+"/"+this.eventId),this.scenario_index=0,this.next_scenario_index=0,this.scenarioCollection.fetch({reset:!0}),this.scenes=[],this.playedScenarioIndexList=[],this.autoSelectedIndex={},this.trigger("xhrStart")},_getNextParameter:function(b){var c=this,d=0;return a(b).each(function(a){if("next"===c.getCommand(a.command)){var b=c.getParam(a.command);d=b[0]?b:d}}),d},_initAutoNext:function(a){var b=this,c=$.Deferred(),d=$.Deferred();this.voiceDeferred=c,this.EventSceneTalkDeferred=d,$.when(c,d).done(function(){b._clearNextSetTimeout(),0!==Game.setting.effect_mode&&b.isSceneAuto()&&(b.isForcefulNext||(J=window.setTimeout(function(){b._canTapCanvas()&&b.next()},b.DURATION_WAITING_MS)))})},_canTapCanvas:function(){return"none"===$(".prt-sel-area").css("display")},_clearNextDeferred:function(a){a=a||{},a.talk!==!0&&this.EventSceneTalkDeferred.reject(),this.voiceDeferred.reject(),this._clearNextSetTimeout()},_clearNextSetTimeout:function(){J&&window.clearTimeout(J),this.clearTimeoutOne(W),this.triggerClearNextSetTimeout()},triggerClearNextSetTimeout:function(){this.trigger("clearNextSetTimeout")},_playVoice:function(a){var b=this;b.voicePath=a,!a||"silent"===a||this.isDisabledVoice()?b.voiceDeferred.resolve():0===Game.setting.sound_flag?b.voiceDeferred.resolve():A.isShellAppAndroid()?(z.playVoice(a),b.isVoiceComplete=!1,$(document).off("shellappAndroidSoundComplete"),$(document).one("shellappAndroidSoundComplete",function(){b.voiceDeferred.resolve(),b.isVoiceComplete=!0})):(z.playVoice(a),b.isVoiceComplete=!1,y.once(a,"complete",function(a){b.voiceDeferred.resolve(),b.isVoiceComplete=!0}))},isDisabledVoice:function(){return 1===+this.ffxiMode},_playEventSceneTalk:function(b,c,d){var e=this,f=b.toJSON(),g=[],h=b.get("detail"),i=0,j=[],k=!1;if(this.eventSceneTalkView=new m,this.addSubView(this.eventSceneTalkView),this._scenario_execute_exception(b),this.stopListening(this.eventSceneTalkView),this.listenToOnce(this.eventSceneTalkView,"talkEnd",function(){e.stopListening(e.eventSceneTalkView),e.EventSceneTalkDeferred.resolve()}),this.listenToOnce(this.eventSceneTalkView,"autoSceneSelect",function(){e.stopListening(e.eventSceneTalkView),e.tryAutoSceneSelect()}),d===!0&&(g=[b.get("sel1_txt"),b.get("sel2_txt"),b.get("sel3_txt"),b.get("sel4_txt"),[b.get("sel1_image"),b.get("sel2_image"),b.get("sel3_image"),b.get("sel4_image"),b.get("sel5_image"),b.get("sel6_image")]],this.hasResponseChoices=!1,+f.quiz_id)){i=+f.quiz_id;var l=this.overwriteQuizChoices(g,i);g=l.choices,j=l.originalTextLen,k=1===+this.quizData[i-1].is_random_sort}if(this.isTutorialScene===!0&&!a.isEmpty(this.tutorialInputtedName)&&this.tutorialTempNameStatus===N[2]||this.shouldReplaceTempName===!0){var n=this.shouldReplaceTempName===!0?this.$el.data("nick-name"):this.tutorialInputtedName;h=h.replace("<span class='nickname'></span>",n)}this.eventSceneTalkView.render(h,c,g,this.isSceneAuto(),this.forcefulOpt,{quizIndex:i,choiceTxtLenList:j,isQuizRandomSort:k})},overwriteQuizChoices:function(b,c){var d=a.clone(b),e=this.quizData[c-1],f=e.choicelist,g="%s",h=[];return a.each(f,function(a,b){h.push(D.getLength(a.text)),d[b].indexOf(g)>-1?d[b]=d[b].replace(g,a.text):d[b]=a.text}),{choices:d,originalTextLen:h}},_scenario_execute_exception:function(a){var b=this.scenarioCollection.length,c=Number(a.get("id")),d=this.scene_id;"scene_fate_chr080_ep1"==d&&47==b&&44==c&&this._initItem(a),"scene_fate_chr026_ep1"==d&&52==b&&49==c&&this._initItem(a),"scene_fate_chr012_ep1"==d&&36==b&&33==c&&this._initItem(a),"scene_fate_chr064_ep1"==d&&35==b&&32==c&&this._initItem(a)},_initItem:function(a){a.attributes.sel1_txt="",
a.attributes.sel2_txt="",a.attributes.sel3_txt="",a.attributes.sel4_txt="",a.attributes.sel_next1="",a.attributes.sel_next2="",a.attributes.sel_next3="",a.attributes.sel_next4="",a.attributes.sel_next5="",a.attributes.sel_next6=""},bg_setting:function(a,b){b.image&&a.attr("src",Game.imgUri+b.image)},char_setting:function(a,b){this.isNotEmpty(b.big_image)&&a.attr("src",Game.imgUri+b.big_image),this.command(a,b,b.position)},getStandPosition:function(a){var b=0;if(a)switch(a){case"R":b=60;break;case"C":b=-0;break;case"L":b=-60;break;case"R2":b=70;break;case"L2":b=-70}return b},canvasOff:function(){},command:function(a,b,c){var d=this,e="0px",f=this.getParam(b.command),g=this.getStandPosition(c),h=null,i=this.getCommand(b.command);if(this.timerId=0,"cjsOpening"===i)return this.delegateEvents({"tap     canvas":"canvasOff","playEnd #cjs-scene-effect":"end"}),this.effectCjs&&(this.effectCjs=null),this.showOnlySceneEffectCjs(),this.$el.find(".prt-scene-stage").css({overflow:"visible",zIndex:0}),void(this.effectCjs=new t({load:f[0]}));if(b.command)switch(i){case Y._SHOW:a.css({opacity:1,"z-index":2,top:e,left:g+"px"}),a.show();break;case Y._HIDE:a.hide();break;case"L-slidein":a.css("opacity",1),a.css("z-index",2),a.hide(),a.css("left",-1*parseInt(a.css("width"))+"px"),a.show(),a.animate({top:e,left:g+"px"},300,function(){d.effect(a,b)});break;case"L-slideout":a.animate({top:e,left:-1*parseInt(a.css("width"))+"px"},1e3,function(){a.hide()});break;case"R-slidein":a.css("opacity",1),a.css("z-index",2),a.hide(),a.css("left",1*parseInt(a.css("width"))+"px"),a.show(),a.animate({top:e,left:g+"px"},300,function(){d.effect(a,b)});break;case"R-slideout":a.animate({top:e,left:1*parseInt(a.css("width"))+"px"},1e3,function(){a.hide()});break;case"T-slidein":a.css("opacity",1),a.css("z-index",2),a.hide(),a.css("top",-1*parseInt(a.css("height"))+"px"),a.show(),a.animate({top:e,left:g},300,function(){d.effect(a,b)});break;case"T-slideout":a.animate({top:-1*parseInt(a.css("height"))+"px",left:g},300,function(){a.hide()});break;case"B-slidein":a.css("opacity",1),a.css("z-index",2),a.hide(),a.css("top",parseInt(a.css("height"))+"px"),a.show(),a.animate({top:e,left:g},300,function(){d.effect(a,b)});break;case"B-slideout":a.animate({top:parseInt(a.css("height"))+"px",left:g},300,function(){a.hide()});break;case"fadein":case Y.TIME_FADE_IN:a.css("opacity",1),a.css("z-index",2),a.hide(),a.animate({top:e,left:g+"px"},0,function(){d.effect(a,b)}),a.hide(),a.fadeIn(i===Y.TIME_FADE_IN?+f[0]:300);break;case"fadeout":case Y.TIME_FADE_OUT:a.fadeOut(i===Y.TIME_FADE_OUT?+f[0]:300);break;case"vague":a.css("z-index",1),a.css("opacity",.5);break;case"worsen":a.css("z-index",1);break;case"color_start":this.colorChange($(".onm-effect-layer"),f[0],f[1],f[2],f[3]);break;case"color_end":$(".onm-effect-layer").css({"background-color":"transparent"});break;case"color_fadein":this.colorFade($(".onm-effect-layer"),f[0],f[1],f[2],f[3],f[4]);break;case"color_fadeout":$(".onm-effect-layer").css({"background-color":"transparent"}).oneTransitionEnd(function(){$(this).attr("style","").off("transitionend webkitTransitionEnd")},1100);break;case"setColorScreenTarget":var j=f[0]?S[f[0]]:T;this.setColorScreenTarget(j);break;case"initColorScreenTarget":this.setColorScreenTarget(T);break;case"initialize":this.initializeEffect();break;case"vibrate":h=this.$el.find(".prt-scene-stage").children(":not(#cjs-scene-effect-container, .onm-effect-layer)"),this.addEffect(h,"shake-regular","0.18s",f[0]);break;case"vibrate_loop_start":var k=f[0]||0;h=this.$el.find(".prt-scene-stage").children(":not(#cjs-scene-effect-container, .onm-effect-layer)"),this.startVibrateLoop(h,180,k);break;case"vibrate_loop_end":h=this.$el.find(".prt-scene-stage").children(":not(#cjs-scene-effect-container, .onm-effect-layer)"),this.stopVibrateLoop(h);break;case"flash":this.addEffect($(".onm-effect-layer"),"to-white-start","0.5s","1");break;case"jump":a.css({top:"10px"}).animate({top:"-25px"},110).animate({top:"10px"},110).animate({top:"0px"},30);break;case"jump_loop_start":this.addEffect(a,"jump-full","0.25s","infinite");break;case"jump_loop_end":this.removeEffect(a,"jump-full");break;case"char_vibrate":this.vibrate_regular(a,180,10,0);break;case"char_vibrate_one":this.vibrate_regular(a,180,10,1);break;case"bg_vibrate":this.vibrate_bg($(".prt-scene-bg"),180,10,0);break;case"bg_vibrate_one":this.vibrate_bg($(".prt-scene-bg"),180,10,1);break;case"phit_sw_0002":this.effectCjs&&this.effectCjs.removeChildren();var l=240+2*g;this.effectCjs=new p({posX:l});break;case"ehit_0001":this.effectCjs&&this.effectCjs.removeChildren();var l=330+2*g;this.effectCjs=new q({posX:l});break;case"ab_3000":this.effectCjs&&this.effectCjs.removeChildren();var l=340+2*g;this.effectCjs=new r({posX:l});break;case"blackin":var m=f[0]||"fadein";null==this.effectCjs?this.effectCjs=new s({motion:m}):"fadeCjs"!=this.effectCjs.identifier?(this.effectCjs.removeChildren(),this.effectCjs=new s({motion:m})):this.effectCjs.motionCall(m);break;case"blackout":var n=f[0]||"fadeout";null==this.effectCjs?this.effectCjs=new s({motion:n}):"fadeCjs"!=this.effectCjs.identifier?(this.effectCjs.removeChildren(),this.effectCjs=new s({motion:n})):this.effectCjs.motionCall(n);break;case"sceneCjs":this.effectCjs&&(this.effectCjs=null);var o=12,w=30,x=o;f[1]&&(x=f[1]>w?w:f[1]);var y=f[2]||this.scene_id;this.effectCjs=new u({motion:f[0]||0,fpsNum:x,scene_id:y,opacity:f[3],isBgEffect:+f[4]||0,posX:f[5]||0,posY:f[6]||0,rotate:f[7]||0,scaleX:f[8]||1,scaleY:f[9]||1,blendModeId:+f[10]||0});break;case"cjsLoad":this.effectCjs&&(this.effectCjs=null),this.effectCjs=new t({load:f[0],label:5});break;case"cjsEncount":$("#btn-auto").remove(),$(".ico-cursor-talk").show(),this.effectCjs&&(this.effectCjs=null),this.showOnlySceneEffectCjs(),this.$el.find(".prt-scene-stage").css("overflow","visible"),this.effectCjs=new t({load:f[0]});break;case"cjsEncountAssignImage":$("#btn-auto").remove(),$(".ico-cursor-talk").show(),this.effectCjs&&(this.effectCjs=null),this.showOnlySceneEffectCjs(),this.$el.find(".prt-scene-stage").css("overflow","visible"),this.effectCjs=new v({load:f[0]});break;case"cjsDelete":this.effectCjs&&this.effectCjs.removeChildren();break;case"cjsFade":if(!this.effectCjs)return;this.effectCjs.getFirstChildOfStage().done(function(a){var b=+f[0],c=+f[1];createjs.Tween.get(a,{override:!0},null,!0).to({alpha:b},c)});break;case"inputTemporaryName":this.isTutorialScene===!0?this.tutorialTempNameStatus=N[1]:this.shouldReplaceTempName=!0;break;case"next":K=setTimeout(function(){d.next("mute")},1e3*f[0]);break;case"next_forceful":this.isForcefulNext=!0,this.forcefulOpt&&(this.$el.find(".btn-header.logView").addClass("disable btn-silent-se"),this.$el.find(".btn-bgm-change").on("tap.forcefulOpt",function(a){a.preventDefault(),a.stopPropagation()})),K=setTimeout(function(){d.isForcefulNext=!1,d.next("mute",!0)},1e3*f[0]);break;case"comic_show":z.playSE("se/page_se_1.mp3");var A=this.$el.find(".tap-blocker");A.css("display","block"),this.$el.find(".prt-comic-display").fadeIn(800,function(){var a=2e3,b="comicDisplay";d.setNamedTimeout(b,function(){A.css("display","none"),d.$el.find(".ico-cursor-talk-comic").css("display","block")},a)});break;case"comic_hide":z.playSE("se/page_se_1.mp3"),this.$el.find(".tap-blocker").css("display","none"),this.$el.find(".prt-comic-display").fadeOut(800),this.$el.find(".ico-cursor-talk-comic").css("display","none")}},effect:function(a,b){if(b.effect)switch(b.effect){case"up_and_down":a.addClass("up_and_down")}},initializeEffect:function(){$(".prt-scene-stage").removeClass().addClass("prt-scene-stage"),$(".onm-effect-layer").removeClass().addClass("onm-effect-layer"),$(".prt-scene-bg").removeClass().addClass("prt-scene-bg"),$(".img-scene-character").removeClass().addClass("img-scene-character")},vibrate_regular:function(a,b,c,d){var e=this,f=0,g=b/5;this.isVibrateCharStopSoon=!1;var h=setInterval(function(){setTimeout(function(){e.vibrateStyle(a,g,"2px")},4*g),setTimeout(function(){e.vibrateStyle(a,g,"-2px")},3*g),setTimeout(function(){e.vibrateStyle(a,g,"2px")},2*g),setTimeout(function(){e.vibrateStyle(a,g,"-2px")},g),e.vibrateStyle(a,g,"2px"),f++,(f>c||e.isVibrateCharStopSoon)&&(setTimeout(function(){e.vibrateStyle(a,1,0),e.isVibrateCharStopSoon=!1},5*g),clearInterval(h))},b);1==d&&(this.isVibrateCharStopNext=!0)},vibrate_bg:function(a,b,c,d){var e=this,f=0,g=b/5;this.isVibrateBgStopSoon=!1;var h=setInterval(function(){setTimeout(function(){e.vibrateStyle(a,g,"2px")},4*g),setTimeout(function(){e.vibrateStyle(a,g,"-2px")},3*g),setTimeout(function(){e.vibrateStyle(a,g,"2px")},2*g),setTimeout(function(){e.vibrateStyle(a,g,"-2px")},g),e.vibrateStyle(a,g,"2px"),f++,(f>c||e.isVibrateBgStopSoon)&&(setTimeout(function(){e.vibrateStyle(a,1,0),e.isVibrateBgStopSoon=!1},5*g),clearInterval(h))},b);1==d&&(this.isVibrateBgStopNext=!0)},vibrateStyle:function(a,b,c){a.css({"-webkit-transition-property":"-webkit-transform","-webkit-transition-duration":b,"-webkit-transform":"translateX("+c+")","transition-property":"transform","transition-duration":b,transform:"translateX("+c+")"})},startVibrateLoop:function(a,b,c){var d=this,e=0,f=b/4;this.isLoopVibrateY=!0;var g=function(){d.isLoopVibrateY&&(setTimeout(function(){0!==c&&e==c?d.stopVibrateLoop():(e++,g())},b),setTimeout(function(){d.vibrateStyleY(a,f,"-1px")},3*f),setTimeout(function(){d.vibrateStyleY(a,f,"1px")},2*f),setTimeout(function(){d.vibrateStyleY(a,f,"-1px")},f),d.vibrateStyleY(a,f,"1px"))};g()},stopVibrateLoop:function(a){this.isLoopVibrateY=!1,this.vibrateStyleY(a,0,"0px")},vibrateStyleY:function(a,b,c){this.isLoopVibrateY||(b=0,c="0px"),a.css({"-webkit-transition-property":"-webkit-transform","-webkit-transition-duration":b,"-webkit-transform":"translateY("+c+")","transition-property":"transform","transition-duration":b,transform:"translateY("+c+")"})},addEffect:function(a,b,c,d){var e=c.replace(/s/g,""),f=1e3*+e,g=a;g.addClass(b).css({"animation-duration":c,"-webkit-animation-duration":c,"animation-iteration-count":d,"-webkit-animation-iteration-count":d}).oneAnimationEnd(function(){$(this).removeClass(b).css("-webkit-animation","")},f+100)},removeEffect:function(a,b){var c=a;c.removeClass(b).css("-webkit-animation","")},colorChange:function(a,b,c,d,e){var f=a;f.css({"background-color":"rgba("+b+","+c+","+d+","+e+")"})},colorFade:function(a,b,c,d,e,f){var g=a;g.css({"background-color":"rgba("+b+","+c+","+d+","+e+")","transition-duration":f,"-webkit-transition-duration":f,"transition-property":"background-color","-webkit-transition-property":"background-color"})},getCommand:function(a){var b=a.indexOf("(");if(-1===b)return a;var c=a.substring(0,b);return c},getParam:function(a){var b=a.indexOf("(");if(-1===b)return Array;var c=a.substring(b+1,a.length-1),d=c.split(",");return d},setColorScreenTarget:function(b){var c=this.$el.find(".onm-effect-layer");this.setColorScreenTarget=function(b){var d=+this.$el.find(b).css("z-index"),e=(a.isNaN(d)?0:d)+1;c.css("z-index",e)},this.setColorScreenTarget(b)},showOnlySceneEffectCjs:function(){var a=this.$el.find(".prt-next-btn-area").siblings(":not(.prt-scene-stage)"),b=this.$el.find(".prt-scene-stage").children(":not(#cjs-scene-effect-container)");this.showOnlySceneEffectCjs=function(){a.hide(),b.hide()},this.showOnlySceneEffectCjs()},webfontSet:function(a){var b="@font-face {font-family: "+a+";src: url("+Game.fontUri+"/scene/"+a+".woff);}",c=document.styleSheets[0],d=c.cssRules.length;c.insertRule(b,d);var e="";this.scenarioCollection.at(0).get("named_npc_id")===O.CAT&&(b="@font-face {font-family: cat_name;src: url("+Game.fontUri+"/cat_name.woff);}",c.insertRule(b,c.cssRules.length),e="cat_name, "),this.$el.find(".prt-scene-comment").add(".prt-log-display").css("font-family","nickname_scene, "+e+a+', "FOT-ニューシネマA Std D", "Average Sans", sans-serif')},setNicknameFont:function(){var a="@font-face{font-family: nickname_scene; src: url("+Game.baseUri+"/user/scene_nickname.woff);}",b=document.styleSheets[0],c=b.cssRules.length;b.insertRule(a,c)},playButtonVoice:function(a){a.stopPropagation();var b=$(a.currentTarget).attr("data-voice");z.playVoice(b,{force:!0})},dummyButtonVoice:function(){this.$el.find(".prt-scene-comment .btn-play-voice").trigger("tap")},disableSkipBtn:function(){this.$el.find(".btn-skip").addClass("disable")},destroy:function(){this.isIOS15OrLater()&&window.removeEventListener("resize",this.onResizeFunc)}},{TRIGGER:I});return Z});