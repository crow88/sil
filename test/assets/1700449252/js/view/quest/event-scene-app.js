define(["model/content","model/data","model/token-data","view/quest/abstract-view","view/quest/event-scene-view","view/quest/event-scene/event-scene-event-footer-view","view/quest/event-scene/event-scene-skip-view","view/popup","lib/shellapp","general"],function(a,b,c,d,e,f,g,h,i,j){var k=null,l=null,m={ON:2,OFF:1},n=d.extend({questId:null,currentLocationId:null,questType:null,scene_id:null,nextUrl:"",forwardFlg:null,popView:null,clearedSceneOnly:!1,constructor:function(a){return this.getInstance(a)},getInstance:function(a){return null===l&&(d.prototype.constructor.call(this,a),l=this),l},initialize:function(b){this.content_bind(),this.questId=b.questId,this.currentLocationId=b.currentLocationId,this.questType=b.questType,this.scene_id=b.scene_id,this.forwardFlg=b.forwardFlg,this.nextUrl=b.nextUrl,this.npcIds=b.npcIds,this.isAgreedToSpoiler=b.isAgreedToSpoiler,this.areaId=b.area_id,this.completedQuestId=b.completed_quest_id,this.locationId=b.location_id,this.sub_contents=b.sub_contents,this.forceFirststoryPlay=b.force_firststory_play||0,this.bookmarkPage=b.bookmarkPage,this.popArcarumNpcId=b.popArcarumNpcId,this.firstClear=b.firstClear||0,this.clearedSceneOnly=b.clearedSceneOnly,this.transcendenceKind=b.transcendenceKind,b.isShowFateContinuePU&&(this.nextFateQuestId=b.questId),this.content_model=new a({controller:"quest",action:"scene"}),this.listenTo(this.content_model,"change",this.render),this.listenTo(this.content_model,"error",this.error),this.content_model.fetch()},events:{"tap .skip_confirm .btn-usual-cancel":"popRemove","tap .skip_confirm .btn-usual-ok":"sceneSkipRequest","tap .pop-synopsis .btn-usual-cancel":"popSynopsisRemove","tap .pop-synopsis .btn-scenario-all-read":"onTapScenarioAllRead","tap .pop-synopsis .btn-scene-skip":"sceneSkipEnd","tap .prt-quest-header .btn-scene-skip":"sceneSkipEnd","tap .btn-auto":"pushAutoButton","tap #cjs-scene-effect":"pushSceneCanvas"},render:function(a){var b=this;this.sub_contents?$("#sub_contents").html(decodeURIComponent(a.get("data"))):this.$el.html(decodeURIComponent(a.get("data")));var c=this.clearedSceneOnly?$.Deferred():null;return this.eventSceneView=this.instanceEventSceneView(function(a){c&&c.resolve(a)}),this.listenTo(this.eventSceneView,e.TRIGGER.LOG_CLOSE,function(){b.footerView.back_event()}),this.eventSceneSkipView=this.instanceEventSceneSkipView(),this.eventSceneView.setEventSceneSkipView(this.eventSceneSkipView),this.listenTo(this.eventSceneSkipView,"tap",function(){b.eventSceneView._clearNextDeferred()}),c&&c.done(function(a){b.eventSceneSkipView.setRedirectUrl(a)}),this.footerView=this.instanceEventSceneEventFooterView(this.eventSceneView),this.listenTo(this.footerView,"pushLogButton",function(){var a="on"===$("#scene_fast_text_mode").data("scene-fast-text-mode"),c={talk:!a};b.eventSceneView._clearNextDeferred(c)}),this.global_initialize(),this},instanceEventSceneView:function(a){var b=new e({questId:this.questId,currentLocationId:this.currentLocationId,questType:this.questType,scene_id:this.scene_id,forwardFlg:this.forwardFlg,nextUrl:this.nextUrl,npcIds:this.npcIds,isAgreedToSpoiler:this.isAgreedToSpoiler,areaId:this.areaId,completed_quest_id:this.completedQuestId,location_id:this.locationId,forceFirststoryPlay:this.forceFirststoryPlay,nextFateQuestId:this.nextFateQuestId,bookmarkPage:this.bookmarkPage,firstClear:this.firstClear,clearedSceneOnly:this.clearedSceneOnly,callbackSetRedirectUrl:a,transcendenceKind:this.transcendenceKind,scenarioCollectionUrl:this.scenarioCollectionUrl||null,redirectUrl:this.redirectUrl||null,isForceRedirect:this.isForceRedirect||!1});return this.addSubView(b),b},instanceEventSceneSkipView:function(){var a=new g({scene_id:this.scene_id,forwardFlg:this.forwardFlg,nextUrl:this.nextUrl,npcIds:this.npcIds,areaId:this.areaId,completed_quest_id:this.completedQuestId,location_id:this.locationId,forceFirststoryPlay:this.forceFirststoryPlay,nextFateQuestId:this.nextFateQuestId,bookmarkPage:this.bookmarkPage,redirectUrl:this.redirectUrl||null,isForceRedirect:this.isForceRedirect||!1});return this.addSubView(a),a},instanceEventSceneEventFooterView:function(a){var b=new f({event_scene:a});return this.addSubView(b),b},popRemove:function(){this.popView.popRemove()},popSynopsisRemove:function(){this.eventSceneSkipView.popView.popRemove()},onTapScenarioAllRead:function(){var a=this;this.popSynopsisRemove(),this.listenToOnce(this.eventSceneSkipView.popView,"popEmptyEnd",function(){a.footerView.openAllScenarioLog()})},sceneSkip:function(){this.content_close(),null!==this.popView&&this.popView.popRemove(),this.eventSceneSkipView.end()},sceneSkipEnd:function(){var a=this,b=window.location.hash,c=this.$el.find(".cnt-quest-scene");c.addClass("disabled"),c.fadeOut(2e3,function(){a.eventSceneView._clearSceneTimeoutID(),b===window.location.hash&&(c.removeClass("disabled"),a.eventSceneSkipView.end())})},pushAutoButton:function(){var a=this,b=$("#btn-auto"),d=this.isOnAutoButton();d?(b.addClass("off"),a.fadeInAutoButton(),i.isShellAppAndroid()&&$(document).off("shellappAndroidSoundComplete")):(b.removeClass("off"),a.fadeOutAutoButton()),localStorage.setItem("mode_scene_auto",d==0)},fadeInAutoButton:function(){this.appearAutoButton(),k&&window.clearTimeout(k)},fadeOutAutoButton:function(){this.appearAutoButton(),this.delayFadeoutAutoButton(2e3)},appearAutoButton:function(){$("#btn-auto").css("opacity",1)},disappearAutoButton:function(){$("#btn-auto").css("opacity",.001)},pushSceneCanvas:function(){this.appearAutoButton(),this.delayFadeoutAutoButton(2e3)},isOnAutoButton:function(){return+!$("#btn-auto").hasClass("off")},delayFadeoutAutoButton:function(a){if(this.isOnAutoButton()){var b=this;this.listenToOnce(this,"runTask",function(){b.disappearAutoButton()}),this.delayRun(a)}},delayRun:function(a){var b=this;k&&window.clearTimeout(k),k=window.setTimeout(function(){b.trigger("runTask")},a)},destroy:function(){l=null}});return n});