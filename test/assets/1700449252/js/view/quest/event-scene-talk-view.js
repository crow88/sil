define(["underscore","backbone","typist","view/quest/abstract-view"],function(a,b,c,d){var e=null,f=d.extend({el:".prt-message-area",isShowSelectArea:!1,render:function(b,c,d,f,g,h){var i=this,j=h||{};this.isShowSelectArea=!1,e&&clearTimeout(e),$(".prt-sel-area").hide(),g&&$(".ico-cursor-talk").css("display","none"),i.$el.html('<span class="txt-message"></span>');var k={height:"auto",fontFamily:"inherit",fontSize:0},l=i.$(".txt-message").typist(k),m=b.split(/<br.*?>/gi),n=i._countMessageLength(m),o=function(){g||$(".ico-cursor-talk").show()},p=function(){var b=d[4],c=a.initial(d,1);if(void 0!==c[0]&&""!==c[0]){$(".cnt-quest-scene .prt-sel-area").css("display","block").append('<div class="btn-sel-taparea"></div>');var e=$(".prt-scene-comment .btn-play-voice");$(".prt-sel-area .btn-sel-taparea").on("cgtouchstart",function(){e.addClass("on")}).on("cgtouchmove cgtouchend",function(){e.removeClass("on")}),$(".btn-skip").css("opacity","0.5"),i.isShowSelectArea=!0,i._renderSelect(c,j)}else if(void 0!==b[0]&&""!==b[0]){$(".cnt-quest-scene .prt-sel-area").css("display","block").append('<div class="btn-sel-taparea"></div>');var e=$(".prt-scene-comment .btn-play-voice");$(".prt-sel-area .btn-sel-taparea").on("cgtouchstart",function(){e.addClass("on")}).on("cgtouchmove cgtouchend",function(){e.removeClass("on")}),$(".btn-skip").css("opacity","0.5"),i.isShowSelectArea=!0,i._renderImageSelect(b)}};if(b.length<=0)return o(),void i.trigger("talkEnd",{message:b,talkLength:n,displayMode:"full"});var q=function(){$(m).each(function(a,b){l.typist("echo",b).typist("wait",500)}),l.typist("wait",600).typist("call",function(){o(),i.trigger("talkEnd",{message:b,talkLength:n,displayMode:"full"})})},r=Game.setting.effect_mode;if(c&&0!=r)$(".btn-skip").css("opacity","1"),$(".ico-cursor-talk").hide(),q();else{this.$(".txt-message").html(b),o(),$(".btn-skip").css("opacity","1");var s=d.length>0;s&&p(),s&&f?i.trigger("autoSceneSelect"):e=setTimeout(function(){i.trigger("talkEnd",{message:b,talkLength:n,displayMode:"simple"})},this.getDurationMS(n))}},_renderSelect:function(b,c){var d=this,e=c||{};this._initSelect();var f=$(".prt-sel-inner"),g=a.without(b,void 0,"").length,h=[];f.removeClass().addClass("prt-sel-inner has-"+g+"-sel"),a.each(b,function(b,c){if("undefined"!=typeof b&&""!==b){var f="";e.quizIndex&&d.isSmallFont(e.choiceTxtLenList?e.choiceTxtLenList[c]:b.length)&&(f+=" txt-small"),h.push(a.template($("#tpl-select-balloon").html(),{textHtml:b,exClass:f,selectIndex:c+1}))}}),e.quizIndex?(f[0].dataset.quizIndex=e.quizIndex,e.isQuizRandomSort&&(h=a.shuffle(h))):delete f[0].dataset.quizIndex;var i=h.join("");f.append(i)},isSmallFont:function(a){var b="ja"===Game.lang?16:32;return a>b},_renderImageSelect:function(b){this._initSelect();var c=$(".prt-sel-inner");c.removeClass().addClass("prt-sel-inner has-img-sel"),a(b).each(function(b,d){void 0!==b&&""!==b&&c.append(a.template($("#tpl-choice-img").html(),{itemId:b}))})},_initSelect:function(){$(".prt-sel-inner").html("")},_countMessageLength:function(a){var b=0,c=!0;for(var d in a)for(var e in a[d])"<"===a[d][e]?c=!1:">"===a[d][e]&&(c=!0),c&&b++;return b}});return f});